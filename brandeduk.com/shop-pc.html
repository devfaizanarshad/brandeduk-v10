<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - BrandedUK</title>
    <script>
        // Redirect to mobile version on smaller screens
        if (window.innerWidth < 1024) {
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category') || 'all';
            window.location.href = '../mobile/shop-mobile.html?category=' + category;
        }
    </script>
    <link rel="stylesheet" href="../brandedukv15-child/assets/css/components/header.css?v=20251230">
    <link rel="stylesheet" href="../mobile/css/social-buttons.css?v=20251230">
    <link rel="stylesheet" href="css/style.css?v=20251230">
    <style>
        /* Social buttons header desktop */
        .header-top .social-buttons-header { gap: 10px; }
        .header-top .social-buttons-header a { width: 32px; height: 32px; }
        .header-top .social-buttons-header .social-icon svg { width: 14px; height: 14px; }
        
        /* Search expand desktop */
        .searchbar-header__search-expand {
            position: relative;
            width: 44px;
            height: 44px;
            transition: width 0.3s ease-in-out;
            margin-right: 8px;
        }
        .searchbar-header__search-expand:focus-within { width: 320px; }
        .searchbar-header__search-expand .search-input-expand {
            position: absolute;
            right: 0;
            top: 0;
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            border-radius: 9999px;
            padding: 12px 44px 12px 20px;
            font-size: 15px;
            background: #f3f4f6;
            color: #1f2937;
            box-sizing: border-box;
        }
        .searchbar-header__search-expand .search-input-expand::placeholder { color: transparent; transition: color 0.2s ease; }
        .searchbar-header__search-expand:focus-within .search-input-expand::placeholder { color: #9ca3af; }
        .searchbar-header__search-expand .search-icon-expand {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            pointer-events: none;
            color: #6b7280;
            transition: color 0.2s ease;
        }
        .searchbar-header__search-expand:focus-within .search-icon-expand { color: #a855f7; }
        
        /* Logo viola */
        .searchbar-header__brand-img { width: 40px; height: 40px; object-fit: contain; }
        .searchbar-header__brand-text { color: #a855f7 !important; }

        /* ===== ACCOUNT PANEL - DESKTOP ===== */
        .account-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 9998;
        }
        .account-overlay.active { opacity: 1; visibility: visible; }
        .account-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: transparent;
            border-radius: 20px;
            width: 600px;
            max-width: 90vw;
            height: 500px;
            max-height: 80vh;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 9999;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        }
        .account-panel.active { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
        .account-panel-header { position: absolute; top: 16px; right: 16px; z-index: 10; }
        .account-close-btn { width: 44px; height: 44px; border: none; background: rgba(0, 0, 0, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .account-close-btn:hover { background: rgba(0, 0, 0, 0.5); transform: scale(1.05); }
        .account-close-btn svg { stroke: #fff; }
        .account-forms-container { display: flex; align-items: stretch; height: 100%; position: relative; overflow: hidden; }
        .account-arrow { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.2); border-radius: 50%; color: rgba(255, 255, 255, 0.8); cursor: pointer; transition: all 0.3s ease; z-index: 10; opacity: 0; visibility: hidden; }
        .account-arrow.visible { opacity: 1; visibility: visible; }
        .account-arrow:hover { background: rgba(0, 0, 0, 0.4); }
        .account-arrow svg { stroke: #fff; }
        .account-forms-wrapper { flex: 1; display: flex; overflow: hidden; width: 100%; position: relative; }
        .account-form-holder { flex-basis: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); cursor: pointer; padding: 24px; }
        .account-form-holder:hover { flex-basis: 55%; }
        .signin-form { background: linear-gradient(135deg, #8455f4 0%, #6b21a8 100%); }
        .signup-form { background: linear-gradient(135deg, #3e4357 0%, #1f2937 100%); }
        .account-form-icon { color: #fff; display: flex; flex-direction: column; align-items: center; gap: 12px; transition: all 0.3s ease; }
        .account-form-icon svg { stroke: #fff; }
        .account-form-icon span { font-size: 1.1rem; font-weight: 600; }
        .account-form-content { position: absolute; width: 85%; top: 100%; opacity: 0; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .account-form-holder.active { flex-basis: 100%; position: absolute; inset: 0; z-index: 2; }
        .account-form-holder.active .account-form-icon { position: absolute; top: 24px; left: 24px; flex-direction: row; gap: 12px; }
        .account-form-holder.active .account-form-icon svg { width: 28px; height: 28px; }
        .account-form-holder.active .account-form-icon span { font-size: 1rem; }
        .account-form-holder.active .account-form-content { top: 80px; opacity: 1; width: 80%; max-width: 400px; left: 50%; transform: translateX(-50%); }
        .account-form-holder.inactive { flex-basis: 0%; opacity: 0; pointer-events: none; }
        .account-input-group { position: relative; margin-bottom: 28px; }
        .account-input-group.half { flex: 1; }
        .account-input-row { display: flex; gap: 16px; }
        .account-input-group label { position: absolute; top: 0; left: 0; color: rgba(255, 255, 255, 0.7); font-size: 14px; transition: all 0.3s ease; pointer-events: none; }
        .account-input-group input { width: 100%; padding: 10px 0; background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.5); color: #fff; font-size: 15px; outline: none; }
        .account-input-group input:focus, .account-input-group input:valid { border-bottom-color: #fff; }
        .account-input-group input:focus + label, .account-input-group input:valid + label { top: -20px; font-size: 11px; color: rgba(255, 255, 255, 0.9); }
        .account-form-actions { display: flex; justify-content: flex-end; margin-top: 20px; }
        .account-submit-btn { width: 50px; height: 50px; border: none; border-radius: 50%; background: rgba(0, 0, 0, 0.3); color: #fff; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .account-submit-btn:hover { background: rgba(0, 0, 0, 0.5); transform: scale(1.05); }
        .account-submit-btn svg { stroke: #fff; }
        .account-forgot-link { display: block; margin-top: 20px; color: rgba(255, 255, 255, 0.7); font-size: 13px; text-decoration: none; transition: color 0.2s; }
        .account-forgot-link:hover { color: #fff; }
        .account-logged-in { padding: 50px 40px; text-align: center; background: #fff; height: 100%; }
        .account-user-avatar { margin-bottom: 16px; }
        .account-user-name { font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .account-user-email { font-size: 14px; color: #6b7280; margin-bottom: 24px; }
        .account-user-details { text-align: left; background: #f9fafb; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
        .account-user-details p { font-size: 14px; color: #4b5563; margin-bottom: 8px; }
        .account-user-details p:last-child { margin-bottom: 0; }
        .account-user-details strong { color: #1f2937; }
        .account-logout-btn { display: inline-flex; align-items: center; gap: 8px; padding: 14px 28px; background: #ef4444; border: none; border-radius: 12px; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .account-logout-btn:hover { background: #dc2626; transform: translateY(-2px); }

        /* Shop Page Styles */
        .shop-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 30px;
            padding: 30px 20px;
            min-height: calc(100vh - 200px);
        }

        /* Filters Sidebar */
        .filters-sidebar {
            position: sticky;
            top: 80px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            overflow-x: hidden;
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }

        /* Custom Scrollbar for Filters Sidebar */
        .filters-sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .filters-sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .filters-sidebar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .filters-sidebar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Firefox scrollbar */
        .filters-sidebar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f1f1;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .clear-all-btn {
            font-size: 13px;
            color: #06b6d4;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .filter-group {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .filter-group:last-child { border-bottom: none; }

        .filter-group h4 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .filter-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .filter-toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #d1d5db;
            border-radius: 999px;
            transition: background 0.2s ease;
        }

        .filter-toggle-switch.active { background: #8b5cf6; }
        .filter-toggle-switch.active-blue { background: #3b82f6; }
        .filter-toggle-switch.active-green { background: #10b981; }

        .filter-toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        .filter-toggle-switch.active::after,
        .filter-toggle-switch.active-blue::after,
        .filter-toggle-switch.active-green::after {
            transform: translateX(20px);
        }

        .filter-search {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 12px;
        }

        .filter-search::placeholder { color: #9ca3af; }

        /* ========================================
           FILTERS - Matching PC Version Style
        ======================================== */
        
        /* Toggle Switches */
        .filter-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .filter-toggle-row:last-child {
            border-bottom: none;
        }

        .filter-toggle-label {
            font-size: 15px;
            font-weight: 500;
            color: #1f2937;
        }

        .filter-toggle-label.label-new-in { color: #17a2b8; }
        .filter-toggle-label.label-bradeal { color: #e85a5a; }
        .filter-toggle-label.label-offers { color: #7c3aed; }
        .filter-toggle-label.label-in-stock { color: #64748b; }
        .filter-toggle-label.label-recycled { color: #14b8a6; }
        .filter-toggle-label.label-plus-sizes { color: #f59e0b; }

        /* Special Filters Dropdown */
        .special-filters-dropdown {
            margin-bottom: 16px;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
        }

        .special-filters-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }

        .special-filters-btn:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #9333ea 100%);
        }

        .special-filters-icon {
            font-size: 16px;
        }

        .special-filters-text {
            flex: 1;
            text-align: left;
        }

        .special-filters-arrow {
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .special-filters-dropdown.open .special-filters-arrow {
            transform: rotate(90deg);
        }

        .special-filters-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 16px;
        }

        .special-filters-dropdown.open .special-filters-content {
            max-height: 400px;
            padding: 16px;
        }

        .special-filters-content .filter-toggle-row {
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .special-filters-content .filter-toggle-row:last-child {
            border-bottom: none;
        }

        .filter-toggle-btn {
            position: relative;
            width: 52px;
            height: 28px;
            border-radius: 14px;
            background: #d1d5db;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .filter-toggle-btn[aria-pressed="true"] { background: #14b8a6; }
        .filter-toggle-btn.toggle-new-in[aria-pressed="true"] { background: #17a2b8; }
        .filter-toggle-btn.toggle-bradeal[aria-pressed="true"] { background: #e85a5a; }
        .filter-toggle-btn.toggle-offers[aria-pressed="true"] { background: #7c3aed; }
        .filter-toggle-btn.toggle-in-stock[aria-pressed="true"] { background: #64748b; }
        .filter-toggle-btn.toggle-recycled[aria-pressed="true"] { background: #14b8a6; }
        .filter-toggle-btn.toggle-plus-sizes[aria-pressed="true"] { background: #f59e0b; }

        .filter-toggle-thumb {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #d1d5db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .filter-toggle-btn[aria-pressed="true"] .filter-toggle-thumb {
            transform: translateX(24px);
        }

        /* Price Range Section */
        .price-range-section {
            padding: 16px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .price-range-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .price-range-header h4 {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .price-range-arrow {
            color: #7c3aed;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .price-range-section.expanded .price-range-arrow {
            transform: rotate(180deg);
        }

        .price-range-display {
            font-size: 14px;
            font-weight: 600;
            color: #17a2b8;
            margin: 12px 0;
        }

        .price-range-slider-container {
            position: relative;
            width: 100%;
            height: 6px;
            margin: 20px 0;
        }

        .price-range-track {
            position: absolute;
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
        }

        .price-range-selected {
            position: absolute;
            height: 6px;
            background: #1f2937;
            border-radius: 3px;
        }

        .price-slider {
            position: absolute;
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: transparent;
            pointer-events: none;
            outline: none;
        }

        .price-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #17a2b8;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: all;
            border: 3px solid white;
        }

        .price-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: #17a2b8;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: all;
            border: 3px solid white;
        }

        .price-range-inputs {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 12px;
        }

        .price-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .price-input-group label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
        }

        .price-input {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #1f2937;
            text-align: center;
        }

        .price-input:focus {
            outline: none;
            border-color: #17a2b8;
        }

        /* Expandable Filter Rows */
        .filter-expandable-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            user-select: none;
        }

        .filter-expandable-row:hover {
            background: #fafafa;
            margin: 0 -24px;
            padding-left: 24px;
            padding-right: 24px;
        }

        .filter-expandable-row h4 {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .filter-expandable-arrow {
            color: #9ca3af;
            font-size: 18px;
            font-weight: 300;
            transition: transform 0.2s ease;
        }

        .filter-expandable-row.expanded .filter-expandable-arrow {
            transform: rotate(90deg);
            color: #7c3aed;
        }

        .filter-expandable-content {
            display: none;
            padding: 12px 0;
        }

        .filter-expandable-row.expanded + .filter-expandable-content {
            display: block;
        }

        /* Filter Checkbox List */
        .filter-checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 4px;
        }

        .filter-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .filter-checkbox-item:hover {
            background: #f3f4f6;
        }

        .filter-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #7c3aed;
            cursor: pointer;
        }

        .filter-checkbox-item label {
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            flex: 1;
        }

        .filter-checkbox-item .count {
            font-size: 12px;
            color: #9ca3af;
        }

        /* Products Section */
        .products-section {
            background: white;
            padding: 24px;
            border-radius: 16px;
            overflow: hidden;
            min-width: 0;
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .products-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            min-width: 0;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .back-btn:hover {
            background: #e5e7eb;
            color: #1f2937;
            border-color: #d1d5db;
        }

        .back-btn svg {
            width: 16px;
            height: 16px;
        }

        .products-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
            white-space: nowrap;
        }

        .products-header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .products-count {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .products-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            white-space: nowrap;
        }

        .control-select {
            padding: 6px 32px 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            background: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            transition: all 0.2s ease;
            min-width: 130px;
        }

        .control-select:hover {
            border-color: #d1d5db;
        }

        .control-select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        /* Product Card */
        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #f3f4f6;
            max-width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }

        .product-media {
            position: relative;
            padding: 16px;
            background: #f9fafb;
            overflow: hidden;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .product-badges {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
            z-index: 10;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .badge.embroidery { background: #3b82f6; color: white; }
        .badge.print { background: #eab308; color: white; }

        .product-image {
            width: 100%;
            height: 100%;
            max-height: 200px;
            object-fit: contain;
        }

        .product-info {
            padding: 16px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 180px; /* Fixed minimum height */
        }

        .product-code-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            height: 20px; /* Fixed height */
        }

        .product-code {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }

        .brand-logo {
            height: 16px;
            opacity: 0.7;
        }

        .brand-name {
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-name {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 40px; /* Fixed height for 2 lines */
            height: 40px;
        }

        .product-price {
            display: flex;
            align-items: baseline;
            gap: 3px;
            margin-bottom: 12px;
            flex-wrap: nowrap;
            white-space: nowrap;
            height: 20px; /* Fixed height */
        }

        .price-label {
            font-size: 10px;
            color: #10b981;
            font-weight: 600;
        }

        .price-value {
            font-size: 12px;
            font-weight: 700;
            color: #1f2937;
        }

        .price-suffix {
            font-size: 9px;
            color: #9ca3af;
        }

        .product-colors-wrapper {
            position: relative;
            margin-top: auto; /* Push to bottom */
            padding-top: 12px;
        }

        .product-colors {
            display: flex;
            gap: 6px;
            align-items: center;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 4px 0;
            height: 40px; /* Fixed height */
        }

        .product-colors::-webkit-scrollbar {
            display: none;
        }

        .color-dot {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: border-color 0.2s ease, transform 0.2s ease;
        }

        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { border-color: #8b5cf6; }

        .color-slider-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
        }

        .color-arrow {
            width: 24px;
            height: 24px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .color-arrow:hover {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        .color-progress {
            flex: 1;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin: 0 8px;
            overflow: hidden;
        }

        .color-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #17a2b8, #8b5cf6);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Pagination - Inline Style */
        .pagination-pages {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin-top: 30px;
            padding-bottom: 30px;
        }

        .pagination-button {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
        }

        .pagination-button:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #1f2937;
        }

        .pagination-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f9fafb;
        }

        .pagination-pages {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-page {
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0 8px;
        }

        .pagination-page:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #1f2937;
        }

        .pagination-page.active {
            background: #1f2937;
            border-color: #1f2937;
            color: white;
            font-weight: 600;
        }

        .pagination-info {
            display: none; /* Hide old pagination info */
        }

        /* Footer */
        .shop-footer {
            background: #1f2937;
            color: white;
            padding: 40px 20px;
            margin-top: 60px;
            text-align: center;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
</head>
<body>

<!-- HEADER -->
<header class="site-header">
    <div class="header-top">
        <div class="header-container">
            <div class="header-top-left">
                <ul class="social-buttons-header">
                    <li><a href="https://www.facebook.com/profile.php?id=100083540654262" class="social-facebook" target="_blank" rel="noopener" aria-label="Facebook">
                        <span class="social-icon"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></span>
                    </a></li>
                    <li><a href="https://www.instagram.com/brandeduk" class="social-instagram" target="_blank" rel="noopener" aria-label="Instagram">
                        <span class="social-icon"><svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></span>
                    </a></li>
                    <li><a href="https://www.linkedin.com/in/anderson-ricotta-92a394321/" class="social-linkedin" target="_blank" rel="noopener" aria-label="LinkedIn">
                        <span class="social-icon"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></span>
                    </a></li>
                    <li><a href="https://www.youtube.com/@barudanamericainc3060" class="social-youtube" target="_blank" rel="noopener" aria-label="YouTube">
                        <span class="social-icon"><svg viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></span>
                    </a></li>
                    <li><a href="https://uk.pinterest.com/pin/7459155629343965/" class="social-pinterest" target="_blank" rel="noopener" aria-label="Pinterest">
                        <span class="social-icon"><svg viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.372 0 12c0 5.084 3.163 9.426 7.627 11.174-.105-.949-.2-2.405.042-3.441.218-.937 1.407-5.965 1.407-5.965s-.359-.719-.359-1.782c0-1.668.967-2.914 2.171-2.914 1.023 0 1.518.769 1.518 1.69 0 1.029-.655 2.568-.994 3.995-.283 1.194.599 2.169 1.777 2.169 2.133 0 3.772-2.249 3.772-5.495 0-2.873-2.064-4.882-5.012-4.882-3.414 0-5.418 2.561-5.418 5.207 0 1.031.397 2.138.893 2.738.098.119.112.224.083.345l-.333 1.36c-.053.22-.174.267-.402.161-1.499-.698-2.436-2.889-2.436-4.649 0-3.785 2.75-7.262 7.929-7.262 4.163 0 7.398 2.967 7.398 6.931 0 4.136-2.607 7.464-6.227 7.464-1.216 0-2.359-.631-2.75-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146C9.57 23.812 10.763 24 12 24c6.627 0 12-5.373 12-12 0-6.628-5.373-12-12-12z"/></svg></span>
                    </a></li>
                </ul>
            </div>
            <div class="header-top-right">
                <a class="header-top-email" href="mailto:info@brandeduk.com">info@brandeduk.com</a>
                <nav class="header-top-links" aria-label="utility navigation">
                    <a href="tel:02089742722" class="header-top-phone">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        0208 974 2722
                    </a>
                    <div class="header-top-vat-control" role="group" aria-label="Toggle VAT pricing">
                        <button class="header-top-vat-toggle" type="button" aria-pressed="false" aria-label="Toggle VAT pricing">
                            <span class="header-top-vat-toggle__label header-top-vat-toggle__label--exc" data-vat-exc>exc vat</span>
                            <span class="header-top-vat-toggle__thumb" aria-hidden="true"></span>
                            <span class="header-top-vat-toggle__label header-top-vat-toggle__label--inc" data-vat-inc>inc vat</span>
                        </button>
                    </div>
                </nav>
            </div>
        </div>
    </div>

    <div class="searchbar-header">
        <div class="searchbar-header__surface">
            <div class="searchbar-header__inner">
                <a class="searchbar-header__brand" href="home-pc.html" aria-label="brandedUK home">
                    <img class="searchbar-header__brand-img" src="../brandedukv15-child/assets/images/ui/bd-logo-3d.png" alt="BD" aria-hidden="true">
                    <span class="searchbar-header__brand-text">branded<span class="searchbar-header__brand-text-highlight">UK</span></span>
                </a>

                <div class="searchbar-header__actions">
                    <div class="searchbar-header__search-expand">
                        <input type="text" class="search-input-expand" placeholder="Search products, brands, categories..." id="searchbarHeaderInput">
                        <svg class="search-icon-expand" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </div>

                    <a class="searchbar-header__action" href="tel:02089742722" aria-label="Call us">
                        <span class="searchbar-header__action-ring is-animating">
                            <svg class="searchbar-header__action-icon" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.5 0 1 .4 1 1V20c0 .5-.5 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.5 0 1 .4 1 1 0 1.2.2 2.5.6 3.6.1.4 0 .7-.2 1l-2.3 2.2z"></path>
                            </svg>
                        </span>
                    </a>

                    <a class="searchbar-header__action" href="https://wa.me/447447348564" target="_blank" rel="noreferrer" aria-label="Chat on WhatsApp">
                        <span class="searchbar-header__action-ring is-animating">
                            <svg class="searchbar-header__action-icon searchbar-header__action-icon--whatsapp" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M12 2C6.48 2 2 6.33 2 11.82c0 1.98.56 3.85 1.6 5.47L2 22l4.89-1.53C8.41 21.4 10.18 21.8 12 21.8c5.52 0 10-4.33 10-9.98C22 6.33 17.52 2 12 2zm0 17.45c-1.65 0-3.27-.45-4.68-1.3l-.34-.2-2.9.91.94-2.8-.22-.36a8.02 8.02 0 0 1-1.23-4.26c0-4.37 3.58-7.92 8.02-7.92 4.41 0 7.98 3.55 7.98 7.92 0 4.37-3.57 8.01-7.97 8.01zm4.55-5.58c-.25-.12-1.48-.73-1.71-.81-.23-.08-.4-.12-.57.12-.17.25-.66.81-.81.98-.15.17-.29.19-.54.07-.25-.12-1.04-.41-1.98-1.3-.73-.66-1.22-1.47-1.37-1.72-.15-.25-.02-.38.11-.5.11-.1.25-.27.38-.4.12-.13.17-.23.25-.39.08-.17.04-.31-.02-.43-.06-.12-.57-1.37-.78-1.88-.21-.5-.42-.43-.57-.44-.15-.01-.32-.02-.49-.02-.17 0-.45.06-.68.31-.23.25-.9.88-.9 2.14s.92 2.49 1.05 2.66c.13.17 1.81 2.87 4.38 3.97.61.26 1.08.41 1.45.52.61.19 1.16.16 1.6.1.49-.07 1.49-.61 1.7-1.2.21-.59.21-1.1.15-1.2-.06-.1-.22-.16-.47-.28z"></path>
                            </svg>
                        </span>
                    </a>

                    <a class="searchbar-header__action searchbar-header__account" href="#" aria-label="My Account" id="accountBtn">
                        <span class="searchbar-header__action-ring is-animating">
                            <svg class="searchbar-header__action-icon" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="header-bottom sticky-header">
        <div class="header-container">
            <div class="category-dropdown has-border" data-visible="false">
                <button type="button" class="category-toggle" aria-haspopup="true" aria-expanded="false" title="Browse Categories">
                    <span class="category-toggle-icon" aria-hidden="true"></span>
                    <span class="category-toggle-label">Browse Categories</span>
                    <span class="category-toggle-caret" aria-hidden="true"></span>
                </button>
                <div class="dropdown-box" role="region" aria-label="Browse categories">
                    <ul class="menu vertical-menu category-menu">
                        <li class="has-children">
                            <a href="category-tshirts.html">
                                <img class="category-icon" src="../brandedukv15-child/assets/images/ui/icons/categories/icon-shirt-71%201.png" alt="" aria-hidden="true">
                                <span class="category-text">T-Shirts</span>
                                <span class="category-caret" aria-hidden="true"></span>
                            </a>
                        </li>
                        <li class="has-children">
                            <a href="category-polo.html">
                                <img class="category-icon" src="../brandedukv15-child/assets/images/ui/icons/categories/Polo.png" alt="" aria-hidden="true">
                                <span class="category-text">Polo Shirts</span>
                                <span class="category-caret" aria-hidden="true"></span>
                            </a>
                        </li>
                        <li class="has-children">
                            <a href="category-hoodies.html">
                                <img class="category-icon" src="../brandedukv15-child/assets/images/ui/icons/categories/icon-hoodies-71%201.png" alt="" aria-hidden="true">
                                <span class="category-text">Hoodies &amp; Sweatshirts</span>
                                <span class="category-caret" aria-hidden="true"></span>
                            </a>
                        </li>
                        <li class="has-children">
                            <a href="category-jackets.html">
                                <img class="category-icon" src="../brandedukv15-child/assets/images/ui/icons/categories/Jacket.png" alt="" aria-hidden="true">
                                <span class="category-text">Jackets &amp; Softshell</span>
                                <span class="category-caret" aria-hidden="true"></span>
                            </a>
                        </li>
                        <li class="has-children">
                            <a href="category-hivis.html">
                                <img class="category-icon" src="../brandedukv15-child/assets/images/ui/icons/categories/Hi%20Vis.png" alt="" aria-hidden="true">
                                <span class="category-text">Hi-Vis Clothing</span>
                                <span class="category-caret" aria-hidden="true"></span>
                            </a>
                        </li>
                        <li class="has-children">
                            <a href="category-fleeces.html">
                                <img class="category-icon" src="../brandedukv15-child/assets/images/ui/icons/categories/Fleece.png" alt="" aria-hidden="true">
                                <span class="category-text">Fleeces</span>
                                <span class="category-caret" aria-hidden="true"></span>
                            </a>
                        </li>
                        <li class="has-children">
                            <a href="category-headwear.html">
                                <img class="category-icon" src="../brandedukv15-child/assets/images/ui/icons/categories/Cap.png" alt="" aria-hidden="true">
                                <span class="category-text">Headwear / Accessories</span>
                                <span class="category-caret" aria-hidden="true"></span>
                            </a>
                        </li>
                        <li>
                            <a href="shop-pc.html?category=all" class="view-all-link">
                                <span class="category-text">View All Categories</span>
                                <span class="category-caret" aria-hidden="true"></span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <nav class="main-nav" aria-label="primary navigation">
                <ul class="menu">
                    <li><a href="shop-pc.html?category=all">All Products</a></li>
                    <li><a href="home-pc.html">BrandedUK</a></li>
                    <li><a href="#">Promotions</a></li>
                    <li><a href="#">More</a></li>
                    <li><a href="#">Services</a></li>
                    <li><a href="#">About</a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>

<!-- SHOP CONTENT -->
<div class="shop-wrapper">
    <!-- Filters Sidebar -->
    <aside class="filters-sidebar">
        <div class="filters-header">
            <h3>Filter By</h3>
            <button class="clear-all-btn">Clear All</button>
        </div>

        <!-- Special Filters Dropdown -->
        <div class="special-filters-dropdown">
            <button type="button" class="special-filters-btn" onclick="this.parentElement.classList.toggle('open')">
                <span class="special-filters-icon">✨</span>
                <span class="special-filters-text">Special Filters</span>
                <span class="special-filters-arrow">›</span>
            </button>
            <div class="special-filters-content">
                <div class="filter-toggle-row">
                    <span class="filter-toggle-label label-new-in">New In</span>
                    <button type="button" class="filter-toggle-btn toggle-new-in" aria-pressed="false">
                        <span class="filter-toggle-thumb"></span>
                    </button>
                </div>
                <div class="filter-toggle-row">
                    <span class="filter-toggle-label label-bradeal">Brandedeal</span>
                    <button type="button" class="filter-toggle-btn toggle-bradeal" aria-pressed="false">
                        <span class="filter-toggle-thumb"></span>
                    </button>
                </div>
                <div class="filter-toggle-row">
                    <span class="filter-toggle-label label-offers">Offers</span>
                    <button type="button" class="filter-toggle-btn toggle-offers" aria-pressed="false">
                        <span class="filter-toggle-thumb"></span>
                    </button>
                </div>
                <div class="filter-toggle-row">
                    <span class="filter-toggle-label label-in-stock">In Stock</span>
                    <button type="button" class="filter-toggle-btn toggle-in-stock" aria-pressed="false">
                        <span class="filter-toggle-thumb"></span>
                    </button>
                </div>
                <div class="filter-toggle-row">
                    <span class="filter-toggle-label label-recycled">Recycled / Organic</span>
                    <button type="button" class="filter-toggle-btn toggle-recycled" aria-pressed="false">
                        <span class="filter-toggle-thumb"></span>
                    </button>
                </div>
                <div class="filter-toggle-row">
                    <span class="filter-toggle-label label-plus-sizes">Plus Sizes</span>
                    <button type="button" class="filter-toggle-btn toggle-plus-sizes" aria-pressed="false">
                        <span class="filter-toggle-thumb"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Search within results -->
        <div class="filter-group">
            <h4>Search products</h4>
            <input type="text" class="filter-search" placeholder="Search within results">
        </div>

        <!-- Price Range -->
        <div class="price-range-section expanded">
            <div class="price-range-header" onclick="this.parentElement.classList.toggle('expanded')">
                <h4>Price Range</h4>
                <span class="price-range-arrow">ˇ</span>
            </div>
            <div class="price-range-display" id="priceRangeDisplay">£14.25 - £64.95</div>
            <div class="price-range-slider-container">
                <div class="price-range-track"></div>
                <div class="price-range-selected" id="priceRangeSelected"></div>
                <input type="range" min="14" max="65" value="14" class="price-slider" id="priceSliderMin">
                <input type="range" min="14" max="65" value="65" class="price-slider" id="priceSliderMax">
            </div>
            <div class="price-range-inputs">
                <div class="price-input-group">
                    <label>Min</label>
                    <input type="text" class="price-input" id="priceInputMin" value="£14">
                </div>
                <div class="price-input-group">
                    <label>Max</label>
                    <input type="text" class="price-input" id="priceInputMax" value="£65">
                </div>
            </div>
        </div>

        <!-- Expandable Filter Rows -->
        <div class="filter-expandable-row">
            <h4>Gender</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="female"><span>Female</span><span class="count">(72)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="male"><span>Male</span><span class="count">(86)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="unisex"><span>Unisex</span><span class="count">(124)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Age Group</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="adult"><span>Adult</span><span class="count">(156)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="infant"><span>Infant</span><span class="count">(18)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="kids"><span>Kids</span><span class="count">(48)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Sleeve</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="long-sleeve-2"><span>Long Sleeve</span><span class="count">(89)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="short-sleeve-2"><span>Short Sleeve</span><span class="count">(67)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="sleeveless"><span>Sleeveless</span><span class="count">(24)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="raglan-sleeve"><span>Raglan Sleeve</span><span class="count">(12)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="set-in-sleeve"><span>Set-In Sleeve</span><span class="count">(8)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="roll-sleeve"><span>Roll-Sleeve</span><span class="count">(6)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Neckline</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="crew-neck-2"><span>Crew Neck</span><span class="count">(95)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="v-neck-2"><span>V-Neck</span><span class="count">(42)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="mandarin"><span>Mandarin</span><span class="count">(15)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="wide-neck"><span>Wide Neck</span><span class="count">(12)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="roll-neck"><span>Roll Neck</span><span class="count">(10)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="button-down-collar"><span>Button-Down Collar</span><span class="count">(38)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="keyhole"><span>Keyhole</span><span class="count">(8)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Accreditations</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="vegan-tested"><span>Vegan Tested</span><span class="count">(12)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="oeko-tex"><span>Oeko-Tex</span><span class="count">(78)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="global-compact"><span>Global Compact</span><span class="count">(15)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="sedex"><span>SEDEX</span><span class="count">(8)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="un-global-compact"><span>UN Global Compact</span><span class="count">(10)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="polylana"><span>Polylana®</span><span class="count">(5)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="ocs-blended-licence"><span>OCS Blended (Licence)</span><span class="count">(18)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="ocs-100-licence"><span>OCS 100 (Licence)</span><span class="count">(22)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="oeko-tex-step"><span>Oeko-Tex STeP</span><span class="count">(14)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="rcs-blended-licence"><span>RCS Blended (Licence)</span><span class="count">(16)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="global-recycled-standard"><span>Global Recycled Standard</span><span class="count">(22)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="sa8000"><span>SA8000</span><span class="count">(6)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="amfori-bsci"><span>Amfori BSCI</span><span class="count">(9)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="recycled"><span>Recycled</span><span class="count">(45)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="b-corp"><span>B Corp</span><span class="count">(4)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="gots-licence"><span>GOTS (Licence)</span><span class="count">(34)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="organic"><span>Organic</span><span class="count">(28)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="fairtrade-"><span>Fairtrade</span><span class="count">(28)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="certified-organic"><span>Certified Organic</span><span class="count">(20)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Primary Colour</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="black"><span>Black</span><span class="count">(142)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="blue"><span>Blue</span><span class="count">(98)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="grey"><span>Grey</span><span class="count">(76)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="green"><span>Green</span><span class="count">(42)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="white"><span>White</span><span class="count">(128)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="red"><span>Red</span><span class="count">(54)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="pink"><span>Pink</span><span class="count">(32)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="yellow"><span>Yellow</span><span class="count">(28)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="neutral"><span>Neutral</span><span class="count">(24)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="purple"><span>Purple</span><span class="count">(26)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="orange"><span>Orange</span><span class="count">(24)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="brown"><span>Brown</span><span class="count">(18)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="pattern"><span>Pattern</span><span class="count">(12)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="other"><span>Other</span><span class="count">(8)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Colour Shade</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="black - black"><span>Black - Black</span><span class="count">(86)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="blue - navy"><span>Blue - Navy</span><span class="count">(98)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="grey - dark grey"><span>Grey - Dark Grey</span><span class="count">(76)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="white - white"><span>White - White</span><span class="count">(128)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Style</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="classic"><span>Classic</span><span class="count">(156)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="crew-neck-1"><span>Crew Neck</span><span class="count">(95)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="hooded-1"><span>Hooded</span><span class="count">(56)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="long-sleeve-1"><span>Long Sleeve</span><span class="count">(89)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="oversized"><span>Oversized</span><span class="count">(34)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="pocket"><span>Pocket</span><span class="count">(78)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="regular"><span>Regular</span><span class="count">(142)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="slim-1"><span>Slim</span><span class="count">(68)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="v-neck"><span>V-Neck</span><span class="count">(42)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="zipped"><span>Zipped</span><span class="count">(42)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Features</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="anti-bacterial"><span>Anti-bacterial</span><span class="count">(15)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="breathable"><span>Breathable</span><span class="count">(32)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="eco"><span>Eco-friendly</span><span class="count">(28)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="heavyweight"><span>Heavyweight</span><span class="count">(45)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="tear-away"><span>Tear-away Label</span><span class="count">(142)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="uv-protection"><span>UV Protection</span><span class="count">(18)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="water-resistant"><span>Water Resistant</span><span class="count">(18)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Size</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="s"><span>S</span><span class="count">(142)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="m"><span>M</span><span class="count">(156)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="l"><span>L</span><span class="count">(156)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="xl"><span>XL</span><span class="count">(142)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="2xl"><span>2XL</span><span class="count">(128)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="3xl"><span>3XL</span><span class="count">(98)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="xs"><span>XS</span><span class="count">(86)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="one-size"><span>One Size</span><span class="count">(24)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="4xl"><span>4XL</span><span class="count">(68)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="5xl"><span>5XL</span><span class="count">(42)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Fabric</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="recycled-100"><span>Recycled (100%)</span><span class="count">(28)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="organic-100"><span>Organic (100%)</span><span class="count">(42)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="polyester-100"><span>Polyester (100%)</span><span class="count">(54)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="cotton-100"><span>Cotton (100%)</span><span class="count">(128)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="nylon-100"><span>Nylon (100%)</span><span class="count">(18)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="ringspun-100"><span>Ringspun (100%)</span><span class="count">(32)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Weight (GSM)</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="0-50gsm"><span>0 - 50gsm</span><span class="count">(24)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="051-100gsm"><span>051 - 100gsm</span><span class="count">(32)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="101-150gsm"><span>101 - 150gsm</span><span class="count">(48)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="151-200gsm"><span>151 - 200gsm</span><span class="count">(124)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="201-250gsm"><span>201 - 250gsm</span><span class="count">(86)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="251-300gsm"><span>251 - 300gsm</span><span class="count">(76)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="over-300gsm"><span>Over 300gsm</span><span class="count">(32)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Fit</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="classic"><span>Classic Fit</span><span class="count">(142)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="comfort"><span>Comfort</span><span class="count">(68)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="crop"><span>Crop</span><span class="count">(18)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="fashion"><span>Fashion Fit</span><span class="count">(24)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="fitted"><span>Fitted</span><span class="count">(38)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="oversized"><span>Oversized</span><span class="count">(34)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="relaxed"><span>Relaxed</span><span class="count">(54)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="semi-fitted"><span>Semi-Fitted</span><span class="count">(28)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Related Sector</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="sport"><span>Sport</span><span class="count">(124)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="corporate"><span>Corporate</span><span class="count">(98)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="hospitality"><span>Hospitality</span><span class="count">(86)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="travel"><span>Travel</span><span class="count">(32)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="fashion"><span>Fashion</span><span class="count">(124)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Related Sport</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="golf"><span>Golf</span><span class="count">(24)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="gym"><span>Gym</span><span class="count">(68)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="swimming"><span>Swimming</span><span class="count">(18)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="rugby"><span>Rugby</span><span class="count">(28)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Tag</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="adhesives"><span>Adhesives</span><span class="count">(12)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="cut-away-inner-label"><span>Cut-away inner label</span><span class="count">(86)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="sewn-tag"><span>Sewn Tag</span><span class="count">(98)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="tagless"><span>Tagless</span><span class="count">(54)</span></label>
            </div>
        </div>

        <div class="filter-expandable-row">
            <h4>Effect</h4>
            <span class="filter-expandable-arrow">›</span>
        </div>
        <div class="filter-expandable-content">
            <div class="filter-checkbox-list">
                <label class="filter-checkbox-item"><input type="checkbox" value="melange"><span>Melange</span><span class="count">(24)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="heather"><span>Heather</span><span class="count">(28)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="tie-dye"><span>Tie-Dye</span><span class="count">(18)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="triblend"><span>TriBlend</span><span class="count">(16)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="washed"><span>Washed</span><span class="count">(32)</span></label>
                <label class="filter-checkbox-item"><input type="checkbox" value="acid-wash"><span>Acid Wash</span><span class="count">(12)</span></label>
            </div>
        </div>

    </aside>

    <!-- Products Section -->
    <section class="products-section">
        <div class="products-header">
            <div class="products-header-left">
                <button type="button" class="back-btn" onclick="window.history.back()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </button>
                <h1 id="categoryTitle">Hoodies</h1>
            <span class="products-count" id="productsCount">0 products</span>
            </div>
            <div class="products-header-right">
                <!-- Sort and View Controls -->
                <div class="products-controls">
                    <div class="control-group">
                        <label for="sortSelect">Sort By:</label>
                        <select id="sortSelect" class="control-select">
                            <option value="best">Best Sellers</option>
                            <option value="brand-az">Brand A-Z</option>
                            <option value="brand-za">Brand Z-A</option>
                            <option value="code-az">Product Code A-Z</option>
                            <option value="code-za">Product Code Z-A</option>
                            <option value="price-lh">Price: Low to High</option>
                            <option value="price-hl">Price: High to Low</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="viewSelect">View:</label>
                        <select id="viewSelect" class="control-select">
                            <option value="24">24 per page</option>
                            <option value="28" selected>28 per page</option>
                            <option value="32">32 per page</option>
                            <option value="48">48 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                </div>
                <!-- Pagination -->
                <div class="pagination-pages" id="paginationTop" style="display: none;">
                    <button type="button" class="pagination-button" id="paginationFirst" title="First page">«</button>
                    <button type="button" class="pagination-button" id="paginationPrev" title="Previous page">&lt;</button>
                    <span id="paginationPageNumbers"></span>
                    <button type="button" class="pagination-button" id="paginationNext" title="Next page">&gt;</button>
                    <button type="button" class="pagination-button" id="paginationLast" title="Last page">»</button>
                </div>
            </div>
        </div>

        <div class="products-grid" id="productsGrid">
            <!-- Products will be rendered by JavaScript -->
        </div>
        
        <!-- Pagination Bottom (keep for backward compatibility, but hide it) -->
        <div class="pagination-container" id="paginationContainer" style="display: none;">
            <button type="button" class="pagination-button" id="prevPage" disabled>Previous</button>
            <span class="pagination-info">
                Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
            </span>
            <button type="button" class="pagination-button" id="nextPage" disabled>Next</button>
        </div>
    </section>
</div>

<!-- Footer -->
<footer class="shop-footer">
    <p>&copy; 2024 BrandedUK. All rights reserved.</p>
</footer>

<script src="../brandedukv15-child/assets/js/header.js?v=20251230"></script>
<script src="../brandedukv15-child/assets/js/api.js?v=20260107"></script>
<script src="js/main.js?v=20251230"></script>
<script>
// ============================================================================
// API INTEGRATION - Desktop Shop Page
// ============================================================================

// Filter value mappings (Frontend HTML values → API values) using API spec exactly
// Most values pass through directly, but some need special mapping
const FILTER_MAPPINGS = {
    // Quick filters (flag[] array param) - special mappings
    quickFilter: {
        'new-in': 'new-in',
        'bradeal': 'raladeal',  // HTML: bradeal -> API: raladeal
        'offers': 'offers',
        'in-stock': 'in-stock',
        'recycled': 'recycled-organic'  // HTML: recycled -> API: recycled-organic
    },
    // Gender - values match API spec directly
    gender: {
        'female': 'female',
        'male': 'male',
        'unisex': 'unisex'
    },
    // Age Group - values match API spec directly
    ageGroup: {
        'adult': 'adult',
        'infant': 'infant',
        'kids': 'kids'
    },
    // Sleeve - values match API spec directly
    sleeve: {
        'long-sleeve-2': 'long-sleeve-2',
        'short-sleeve-2': 'short-sleeve-2',
        'sleeveless': 'sleeveless',
        'raglan-sleeve': 'raglan-sleeve',
        'set-in-sleeve': 'set-in-sleeve',
        'roll-sleeve': 'roll-sleeve'
    },
    // Neckline - values match API spec directly
    neckline: {
        'crew-neck-2': 'crew-neck-2',
        'v-neck-2': 'v-neck-2',
        'mandarin': 'mandarin',
        'wide-neck': 'wide-neck',
        'roll-neck': 'roll-neck',
        'button-down-collar': 'button-down-collar',
        'keyhole': 'keyhole'
    },
    // Accreditations - values match API spec directly
    accreditations: {
        'vegan-tested': 'vegan-tested',
        'oeko-tex': 'oeko-tex',
        'global-compact': 'global-compact',
        'sedex': 'sedex',
        'un-global-compact': 'un-global-compact',
        'polylana': 'polylana',
        'ocs-blended-licence': 'ocs-blended-licence',
        'ocs-100-licence': 'ocs-100-licence',
        'oeko-tex-step': 'oeko-tex-step',
        'rcs-blended-licence': 'rcs-blended-licence',
        'global-recycled-standard': 'global-recycled-standard',
        'sa8000': 'sa8000',
        'amfori-bsci': 'amfori-bsci',
        'recycled': 'recycled',
        'b-corp': 'b-corp',
        'gots-licence': 'gots-licence',
        'organic': 'organic',
        'fairtrade-': 'fairtrade-',
        'certified-organic': 'certified-organic'
    },
    // Primary Colour - values match API spec directly
    primaryColour: {
        'black': 'black',
        'blue': 'blue',
        'grey': 'grey',
        'green': 'green',
        'white': 'white',
        'red': 'red',
        'pink': 'pink',
        'yellow': 'yellow',
        'neutral': 'neutral',
        'purple': 'purple',
        'orange': 'orange',
        'brown': 'brown',
        'pattern': 'pattern',
        'other': 'other'
    },
    // Colour Shade - values match API spec directly
    colourShade: {
        'black - black': 'black - black',
        'blue - navy': 'blue - navy',
        'grey - dark grey': 'grey - dark grey',
        'white - white': 'white - white'
    },
    // Style - values match API spec directly
    style: {
        'classic': 'classic',
        'crew-neck-1': 'crew-neck-1',
        'hooded-1': 'hooded-1',
        'long-sleeve-1': 'long-sleeve-1',
        'oversized': 'oversized',
        'pocket': 'pocket',
        'regular': 'regular',
        'slim-1': 'slim-1',
        'v-neck': 'v-neck',
        'zipped': 'zipped'
    },
    // Features - values match API spec directly
    feature: {
        'anti-bacterial': 'anti-bacterial',
        'breathable': 'breathable',
        'eco': 'eco',
        'heavyweight': 'heavyweight',
        'tear-away': 'tear-away',
        'uv-protection': 'uv-protection',
        'water-resistant': 'water-resistant'
    },
    // Size - values match API spec directly
    size: {
        's': 's',
        'm': 'm',
        'l': 'l',
        'xl': 'xl',
        '2xl': '2xl',
        '3xl': '3xl',
        'xs': 'xs',
        'one-size': 'one-size',
        '4xl': '4xl',
        '5xl': '5xl'
    },
    // Fabric - values match API spec directly
    fabric: {
        'recycled-100': 'recycled-100',
        'organic-100': 'organic-100',
        'polyester-100': 'polyester-100',
        'cotton-100': 'cotton-100',
        'nylon-100': 'nylon-100',
        'ringspun-100': 'ringspun-100'
    },
    // Weight - values match API spec directly
    weight: {
        '0-50gsm': '0-50gsm',
        '051-100gsm': '051-100gsm',
        '101-150gsm': '101-150gsm',
        '151-200gsm': '151-200gsm',
        '201-250gsm': '201-250gsm',
        '251-300gsm': '251-300gsm',
        'over-300gsm': 'over-300gsm'
    },
    // Fit - values match API spec directly
    fit: {
        'classic': 'classic',
        'comfort': 'comfort',
        'crop': 'crop',
        'fashion': 'fashion',
        'fitted': 'fitted',
        'oversized': 'oversized',
        'relaxed': 'relaxed',
        'semi-fitted': 'semi-fitted'
    },
    // Related Sector - values match API spec directly
    sector: {
        'sport': 'sport',
        'corporate': 'corporate',
        'hospitality': 'hospitality',
        'travel': 'travel',
        'fashion': 'fashion'
    },
    // Related Sport - values match API spec directly
    sport: {
        'golf': 'golf',
        'gym': 'gym',
        'swimming': 'swimming',
        'rugby': 'rugby'
    },
    // Tag - values match API spec directly
    tag: {
        'adhesives': 'adhesives',
        'cut-away-inner-label': 'cut-away-inner-label',
        'sewn-tag': 'sewn-tag',
        'tagless': 'tagless'
    },
    // Effect - values match API spec directly
    effect: {
        'melange': 'melange',
        'heather': 'heather',
        'tie-dye': 'tie-dye',
        'triblend': 'triblend',
        'washed': 'washed',
        'acid-wash': 'acid-wash'
    }
};

// State
let currentState = {
    page: 1,
    limit: 28,
    total: 0,
    category: 'all',
    search: '',
    priceMin: null,
    priceMax: null,
    sort: 'best',
    filters: {
        gender: [],
        ageGroup: [],
        sleeve: [],
        neckline: [],
        fabric: [],
        size: [],
        primaryColour: [],
        colourShade: [],
        style: [],
        tag: [],
        weight: [],
        fit: [],
        sector: [],
        sport: [],
        effect: [],
        accreditations: [],
        features: [],
        quickFilters: []
    }
};

let isLoading = false;

// Legacy static data (kept for fallback, but not used)
const PRODUCTS_DB_LEGACY = [
    {
        code: "GD067",
        name: "Softstyle™ midweight fleece adult hoodie",
        price: "17.58",
        category: "hoodies",
        image: "https://i.postimg.cc/fbC2Zn4L/GD067-Aquatic-FT.jpg",
        colors: [
            {name: "Aquatic", main: "https://i.postimg.cc/fbC2Zn4L/GD067-Aquatic-FT.jpg"},
            {name: "Ash Grey", main: "https://i.postimg.cc/fbC2Zn4t/GD067-Ash-Grey-FT.jpg"},
            {name: "Black", main: "https://i.postimg.cc/R0ds95rf/GD067-Black-FT.jpg"},
            {name: "Blue Dusk", main: "https://i.postimg.cc/QMm4sGLJ/GD067-Blue-Dusk-FT.jpg"},
            {name: "Brown Savana", main: "https://i.postimg.cc/wvBWjfHL/GD067-Brown-Savana-FT.jpg"},
            {name: "Cardinal Red", main: "https://i.postimg.cc/SsKZxTqV/GD067-Cardinal-Red-FT.jpg"},
            {name: "Carolina Blue", main: "https://i.postimg.cc/V6N7kG1D/GD067-Carolina-Blue-FT.jpg"},
            {name: "Cement", main: "https://i.postimg.cc/fLbHR2Z2/GD067-Cement-FT.jpg"},
            {name: "Charcoal", main: "https://i.postimg.cc/4d38xLZF/GD067-Charcoal-FT.jpg"},
            {name: "Cobalt", main: "https://i.postimg.cc/sX2ng6yL/GD067-Cobalt-FT.jpg"},
            {name: "Cocoa", main: "https://i.postimg.cc/d10WVHvb/GD067-Cocoa-FT.jpg"},
            {name: "Daisy", main: "https://i.postimg.cc/1tzW3Cs1/GD067-Daisy-FT.jpg"},
            {name: "Dark Heather", main: "https://i.postimg.cc/j5kMwHdk/GD067-Dark-Heather-FT.jpg"},
            {name: "Dusty Rose", main: "https://i.postimg.cc/fLg8tcTP/GD067-Dusty-Rose-FT.jpg"},
            {name: "Forest Green", main: "https://i.postimg.cc/FRnTdys8/GD067-Forest-Green-FT.jpg"},
            {name: "Light Pink", main: "https://i.postimg.cc/G2SX8FhW/GD067-Light-Pink-FT.jpg"},
            {name: "Maroon", main: "https://i.postimg.cc/zBPxbCG1/GD067-Maroon-FT.jpg"},
            {name: "Military Green", main: "https://i.postimg.cc/TwHtLV3f/GD067-Military-Green-FT.jpg"},
            {name: "Mustard", main: "https://i.postimg.cc/MTr9M7pZ/GD067-Mustard-FT.jpg"},
            {name: "Navy", main: "https://i.postimg.cc/MTr9M7pp/GD067-Navy-FT.jpg"},
            {name: "Off-White", main: "https://i.postimg.cc/nzw3j4hz/GD067-Off-White-FT.jpg"},
            {name: "Paragon", main: "https://i.postimg.cc/j5kMwHSL/GD067-Paragon-FT.jpg"},
            {name: "Pink Lemonade", main: "https://i.postimg.cc/zBPxbCGy/GD067-Pink-Lemonade-FT.jpg"},
            {name: "Pistachio", main: "https://i.postimg.cc/xCF6Jv1N/GD067-Pistachio-FT.jpg"},
            {name: "Purple", main: "https://i.postimg.cc/C5BmjRRx/GD067-Purple-FT.jpg"},
            {name: "Red", main: "https://i.postimg.cc/brD3QZZd/GD067-Red-FT.jpg"},
            {name: "Sport Grey", main: "https://i.postimg.cc/zvb0nyyg/GD067-Ringspun-Sport-Grey-FT.jpg"},
            {name: "Royal", main: "https://i.postimg.cc/VNmG3sVH/GD067-Royal-FT.jpg"},
            {name: "Sage", main: "https://i.postimg.cc/tgpSLRcy/GD067-Sage-FT.jpg"},
            {name: "Sand", main: "https://i.postimg.cc/Bv4YdZz3/GD067-Sand-FT.jpg"},
            {name: "Sky", main: "https://i.postimg.cc/YSMnJ2Pc/GD067-Sky-FT.jpg"},
            {name: "Smoke", main: "https://i.postimg.cc/Xv4HTNPb/GD067-Smoke-FT.jpg"},
            {name: "Stone Blue", main: "https://i.postimg.cc/g0mSfc72/GD067-Stone-Blue-FT.jpg"},
            {name: "Tangerine", main: "https://i.postimg.cc/25GcmRpr/GD067-Tangerine-FT.jpg"},
            {name: "Texas Orange", main: "https://i.postimg.cc/TP07GM8x/GD067-Texas-Orange-FT.jpg"},
            {name: "White", main: "https://i.postimg.cc/1zBCPhxQ/GD067-White-FT.jpg"},
            {name: "Yellow Haze", main: "https://i.postimg.cc/W48WjLRN/GD067-Yellow-Haze-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "Gildan"
    },
    {
        code: "GD057",
        name: "Heavy Blend™ adult full zip hooded sweatshirt",
        price: "42.50",
        category: "hoodies",
        image: "https://i.postimg.cc/R0ds95rf/GD067-Black-FT.jpg",
        colors: [
            {name: "Black", main: "https://i.postimg.cc/R0ds95rf/GD067-Black-FT.jpg"},
            {name: "Navy", main: "https://i.postimg.cc/MTr9M7pp/GD067-Navy-FT.jpg"},
            {name: "Sport Grey", main: "https://i.postimg.cc/zvb0nyyg/GD067-Ringspun-Sport-Grey-FT.jpg"},
            {name: "Red", main: "https://i.postimg.cc/brD3QZZd/GD067-Red-FT.jpg"},
            {name: "Royal", main: "https://i.postimg.cc/VNmG3sVH/GD067-Royal-FT.jpg"},
            {name: "Forest Green", main: "https://i.postimg.cc/FRnTdys8/GD067-Forest-Green-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "Gildan"
    },
    {
        code: "JH001",
        name: "College hoodie",
        price: "28.99",
        category: "hoodies",
        image: "https://i.postimg.cc/QMm4sGLJ/GD067-Blue-Dusk-FT.jpg",
        colors: [
            {name: "Blue Dusk", main: "https://i.postimg.cc/QMm4sGLJ/GD067-Blue-Dusk-FT.jpg"},
            {name: "Charcoal", main: "https://i.postimg.cc/4d38xLZF/GD067-Charcoal-FT.jpg"},
            {name: "White", main: "https://i.postimg.cc/1zBCPhxQ/GD067-White-FT.jpg"},
            {name: "Purple", main: "https://i.postimg.cc/C5BmjRRx/GD067-Purple-FT.jpg"},
            {name: "Mustard", main: "https://i.postimg.cc/MTr9M7pZ/GD067-Mustard-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "AWDis"
    },
    {
        code: "JH050",
        name: "Zoodie",
        price: "55.00",
        category: "hoodies",
        image: "https://i.postimg.cc/wvBWjfHL/GD067-Brown-Savana-FT.jpg",
        colors: [
            {name: "Brown Savana", main: "https://i.postimg.cc/wvBWjfHL/GD067-Brown-Savana-FT.jpg"},
            {name: "Sage", main: "https://i.postimg.cc/tgpSLRcy/GD067-Sage-FT.jpg"},
            {name: "Sand", main: "https://i.postimg.cc/Bv4YdZz3/GD067-Sand-FT.jpg"},
            {name: "Cobalt", main: "https://i.postimg.cc/sX2ng6yL/GD067-Cobalt-FT.jpg"},
            {name: "Dusty Rose", main: "https://i.postimg.cc/fLg8tcTP/GD067-Dusty-Rose-FT.jpg"},
            {name: "Pistachio", main: "https://i.postimg.cc/xCF6Jv1N/GD067-Pistachio-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "AWDis"
    },
    {
        code: "B301",
        name: "Organic pullover hoodie",
        price: "64.95",
        category: "hoodies",
        image: "https://i.postimg.cc/SsKZxTqV/GD067-Cardinal-Red-FT.jpg",
        colors: [
            {name: "Cardinal Red", main: "https://i.postimg.cc/SsKZxTqV/GD067-Cardinal-Red-FT.jpg"},
            {name: "Maroon", main: "https://i.postimg.cc/zBPxbCG1/GD067-Maroon-FT.jpg"},
            {name: "Military Green", main: "https://i.postimg.cc/TwHtLV3f/GD067-Military-Green-FT.jpg"},
            {name: "Texas Orange", main: "https://i.postimg.cc/TP07GM8x/GD067-Texas-Orange-FT.jpg"},
            {name: "Tangerine", main: "https://i.postimg.cc/25GcmRpr/GD067-Tangerine-FT.jpg"}
        ],
        customization: ["embroidery"],
        brand: "B&C"
    },
    {
        code: "RX350",
        name: "Pro RTX hoodie",
        price: "14.25",
        category: "hoodies",
        image: "https://i.postimg.cc/V6N7kG1D/GD067-Carolina-Blue-FT.jpg",
        colors: [
            {name: "Carolina Blue", main: "https://i.postimg.cc/V6N7kG1D/GD067-Carolina-Blue-FT.jpg"},
            {name: "Sky", main: "https://i.postimg.cc/YSMnJ2Pc/GD067-Sky-FT.jpg"},
            {name: "Stone Blue", main: "https://i.postimg.cc/g0mSfc72/GD067-Stone-Blue-FT.jpg"},
            {name: "Cement", main: "https://i.postimg.cc/fLbHR2Z2/GD067-Cement-FT.jpg"},
            {name: "Ash Grey", main: "https://i.postimg.cc/fbC2Zn4t/GD067-Ash-Grey-FT.jpg"},
            {name: "Smoke", main: "https://i.postimg.cc/Xv4HTNPb/GD067-Smoke-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "Pro RTX"
    },
    {
        code: "SS14",
        name: "Classic 80/20 hooded sweat",
        price: "22.75",
        category: "hoodies",
        image: "https://i.postimg.cc/R0ds95rf/GD067-Black-FT.jpg",
        colors: [
            {name: "Black", main: "https://i.postimg.cc/R0ds95rf/GD067-Black-FT.jpg"},
            {name: "Navy", main: "https://i.postimg.cc/MTr9M7pp/GD067-Navy-FT.jpg"},
            {name: "Red", main: "https://i.postimg.cc/brD3QZZd/GD067-Red-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "Fruit of the Loom"
    },
    {
        code: "JH003",
        name: "Sports polyester hoodie",
        price: "35.50",
        category: "hoodies",
        image: "https://i.postimg.cc/VNmG3sVH/GD067-Royal-FT.jpg",
        colors: [
            {name: "Royal", main: "https://i.postimg.cc/VNmG3sVH/GD067-Royal-FT.jpg"},
            {name: "Black", main: "https://i.postimg.cc/R0ds95rf/GD067-Black-FT.jpg"},
            {name: "Navy", main: "https://i.postimg.cc/MTr9M7pp/GD067-Navy-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "AWDis"
    },
    {
        code: "UC502",
        name: "Classic hooded sweatshirt",
        price: "18.99",
        category: "hoodies",
        image: "https://i.postimg.cc/fLg8tcTP/GD067-Dusty-Rose-FT.jpg",
        colors: [
            {name: "Dusty Rose", main: "https://i.postimg.cc/fLg8tcTP/GD067-Dusty-Rose-FT.jpg"},
            {name: "Purple", main: "https://i.postimg.cc/C5BmjRRx/GD067-Purple-FT.jpg"},
            {name: "White", main: "https://i.postimg.cc/1zBCPhxQ/GD067-White-FT.jpg"}
        ],
        customization: ["embroidery"],
        brand: "Uneek"
    },
    {
        code: "RG045",
        name: "Pro hoodie",
        price: "48.25",
        category: "hoodies",
        image: "https://i.postimg.cc/FRnTdys8/GD067-Forest-Green-FT.jpg",
        colors: [
            {name: "Forest Green", main: "https://i.postimg.cc/FRnTdys8/GD067-Forest-Green-FT.jpg"},
            {name: "Charcoal", main: "https://i.postimg.cc/4d38xLZF/GD067-Charcoal-FT.jpg"},
            {name: "Black", main: "https://i.postimg.cc/R0ds95rf/GD067-Black-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "Regatta"
    },
    {
        code: "SG27",
        name: "Contrast hoodie",
        price: "26.50",
        category: "hoodies",
        image: "https://i.postimg.cc/sX2ng6yL/GD067-Cobalt-FT.jpg",
        colors: [
            {name: "Cobalt", main: "https://i.postimg.cc/sX2ng6yL/GD067-Cobalt-FT.jpg"},
            {name: "Charcoal", main: "https://i.postimg.cc/4d38xLZF/GD067-Charcoal-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "SG"
    },
    {
        code: "ST5600",
        name: "Active bonded fleece hoody",
        price: "59.95",
        category: "hoodies",
        image: "https://i.postimg.cc/MTr9M7pZ/GD067-Mustard-FT.jpg",
        colors: [
            {name: "Mustard", main: "https://i.postimg.cc/MTr9M7pZ/GD067-Mustard-FT.jpg"},
            {name: "Tangerine", main: "https://i.postimg.cc/25GcmRpr/GD067-Tangerine-FT.jpg"}
        ],
        customization: ["embroidery"],
        brand: "Stedman"
    },
    {
        code: "K443",
        name: "Hooded sweatshirt",
        price: "31.75",
        category: "hoodies",
        image: "https://i.postimg.cc/tgpSLRcy/GD067-Sage-FT.jpg",
        colors: [
            {name: "Sage", main: "https://i.postimg.cc/tgpSLRcy/GD067-Sage-FT.jpg"},
            {name: "Sand", main: "https://i.postimg.cc/Bv4YdZz3/GD067-Sand-FT.jpg"},
            {name: "Off-White", main: "https://i.postimg.cc/nzw3j4hz/GD067-Off-White-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "Kariban"
    },
    {
        code: "RX101",
        name: "Pro hoody",
        price: "39.99",
        category: "hoodies",
        image: "https://i.postimg.cc/zBPxbCG1/GD067-Maroon-FT.jpg",
        colors: [
            {name: "Maroon", main: "https://i.postimg.cc/zBPxbCG1/GD067-Maroon-FT.jpg"},
            {name: "Military Green", main: "https://i.postimg.cc/TwHtLV3f/GD067-Military-Green-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "Pro RTX"
    },
    {
        code: "WD072",
        name: "Workwear hoodie",
        price: "45.00",
        category: "hoodies",
        image: "https://i.postimg.cc/TP07GM8x/GD067-Texas-Orange-FT.jpg",
        colors: [
            {name: "Texas Orange", main: "https://i.postimg.cc/TP07GM8x/GD067-Texas-Orange-FT.jpg"},
            {name: "Navy", main: "https://i.postimg.cc/MTr9M7pp/GD067-Navy-FT.jpg"},
            {name: "Black", main: "https://i.postimg.cc/R0ds95rf/GD067-Black-FT.jpg"}
        ],
        customization: ["embroidery"],
        brand: "Dickies"
    },
    {
        code: "FH002",
        name: "Premium zip hoodie",
        price: "52.50",
        category: "hoodies",
        image: "https://i.postimg.cc/G2SX8FhW/GD067-Light-Pink-FT.jpg",
        colors: [
            {name: "Light Pink", main: "https://i.postimg.cc/G2SX8FhW/GD067-Light-Pink-FT.jpg"},
            {name: "Daisy", main: "https://i.postimg.cc/1tzW3Cs1/GD067-Daisy-FT.jpg"},
            {name: "Pistachio", main: "https://i.postimg.cc/xCF6Jv1N/GD067-Pistachio-FT.jpg"}
        ],
        customization: ["embroidery", "print"],
        brand: "FDM"
    }
];

// ============================================================================
// API INTEGRATION FUNCTIONS
// ============================================================================

// Parse URL parameters
const urlParams = new URLSearchParams(window.location.search);

// Category normalization and API name mapping
function normalizeCategory(raw) {
    const value = String(raw || '').trim().toLowerCase();
    if (!value) return 'all';
    const aliases = {
        't-shirt': 'tshirts', 't-shirts': 'tshirts', 'tees': 'tshirts', 'tee': 'tshirts',
        'polo-shirts': 'polo', 'polos': 'polo',
        'hi-viz': 'hivis', 'hi-vis': 'hivis', 'hi-vis clothing': 'hivis', 'hi-viz clothing': 'hivis'
    };
    return aliases[value] || value;
}

// Map frontend category slug to API productType name
function getApiCategoryName(categorySlug) {
    const slugToApiName = {
        'tshirts': 'T-Shirts',
        'caps': 'Caps',
        'hoodies': 'Hoodies',
        'jackets': 'Jackets',
        'polo': 'Polos',
        'shirts': 'Shirts',
        'sweatshirts': 'Sweatshirts',
        'beanies': 'Beanies',
        'blouses': 'Blouses',
        'chinos': 'Chinos',
        'fleeces': 'Fleeces',
        'hivis': 'Hi-Vis',
        'trousers': 'Trousers',
        'workwear': 'Workwear'
    };
    return slugToApiName[categorySlug] || null;
}

// Initialize state from URL
let categoryFilter = normalizeCategory(urlParams.get('category')) || 'all';
currentState.category = categoryFilter;
currentState.page = parseInt(urlParams.get('page')) || 1;
currentState.limit = parseInt(urlParams.get('limit')) || 28;
currentState.sort = urlParams.get('sort') || 'best';
currentState.search = urlParams.get('q') || '';
currentState.priceMin = urlParams.get('priceMin') ? parseFloat(urlParams.get('priceMin')) : null;
currentState.priceMax = urlParams.get('priceMax') ? parseFloat(urlParams.get('priceMax')) : null;

// Handle style parameter (subcategory) from URL
const styleParam = urlParams.get('style');
if (styleParam) {
    // Add style to filters if not already present
    if (!currentState.filters.style) {
        currentState.filters.style = [];
    }
    // Add style slug to filters (API expects style slugs)
    const styleSlug = styleParam.toLowerCase().trim();
    if (!currentState.filters.style.includes(styleSlug)) {
        currentState.filters.style.push(styleSlug);
    }
}

// Map frontend filter values to API slugs
function mapFilterValue(filterType, frontendValue) {
    const mapping = FILTER_MAPPINGS[filterType];
    return mapping && mapping[frontendValue] ? mapping[frontendValue] : frontendValue;
}

// Build API params from current state
function buildApiParams() {
    const params = {};

    // Pagination (always included)
    params.page = currentState.page || 1;
    params.limit = currentState.limit || 28;

    // Sort parameter
    if (currentState.sort) {
        // Map frontend sort values to API sort values
        const sortMap = {
            'best': 'best',
            'brand-az': 'brand-az',
            'brand-za': 'brand-za',
            'code-az': 'code-az',
            'code-za': 'code-za',
            'price-lh': 'price-lh',
            'price-hl': 'price-hl'
        };
        const apiSort = sortMap[currentState.sort] || currentState.sort;
        params.sort = apiSort;
    }

    // Search query (mutually exclusive with productType)
    // According to API spec: if q is present, productType is set to null
    if (currentState.search && currentState.search.trim()) {
        params.q = currentState.search.trim();
        // Don't set productType when search is present (mutually exclusive)
    } else if (currentState.category !== 'all') {
        // Map category slug to API productType name only if no search
        const apiCategoryName = getApiCategoryName(currentState.category);
        if (apiCategoryName) {
            params.productType = apiCategoryName;
        } else {
            params.productType = currentState.category;
        }
    }

    // Price range (numeric values)
    // Send priceMin and priceMax if they are set (even if they match the full range)
    if (currentState.priceMin !== null && currentState.priceMin !== undefined) {
        params.priceMin = Number(currentState.priceMin);
        console.log('💰 Adding priceMin to API params:', params.priceMin);
    } else {
        console.log('💰 priceMin is null/undefined, not adding to API params');
    }
    if (currentState.priceMax !== null && currentState.priceMax !== undefined) {
        params.priceMax = Number(currentState.priceMax);
        console.log('💰 Adding priceMax to API params:', params.priceMax);
    } else {
        console.log('💰 priceMax is null/undefined, not adding to API params');
    }

    // Build array parameters from filters
    // Map each filter key to its API parameter name
    const filterMap = {
        'gender': 'gender',
        'ageGroup': 'ageGroup',
        'sleeve': 'sleeve',
        'neckline': 'neckline',
        'accreditations': 'accreditations',
        'primaryColour': 'primaryColour',
        'colourShade': 'colourShade',
        'style': 'style',
        'feature': 'feature', // Singular, not features
        'size': 'size',
        'fabric': 'fabric',
        'weight': 'weight',
        'fit': 'fit',
        'sector': 'sector',
        'sport': 'sport',
        'tag': 'tag',
        'effect': 'effect'
    };

    // Process each filter
    Object.keys(currentState.filters).forEach(filterKey => {
        const filterValues = currentState.filters[filterKey];
        // Ensure filterValues is an array
        const values = Array.isArray(filterValues) ? filterValues : [];
        
        if (values.length > 0) {
            const apiParam = filterMap[filterKey];
            if (apiParam) {
                // Map each value using FILTER_MAPPINGS
                const mappedValues = values.map(val => {
                    return FILTER_MAPPINGS[filterKey]?.[val] || val;
                }).filter(v => v); // Remove any null/undefined values
                
                if (mappedValues.length > 0) {
                    // Store as array param: paramName[] = [value1, value2, ...]
                    params[`${apiParam}[]`] = mappedValues;
                }
            }
        }
    });

    // Handle quick filters separately (flag[] param with special mappings)
    if (currentState.filters.quickFilters) {
        const quickValues = Array.isArray(currentState.filters.quickFilters) 
            ? currentState.filters.quickFilters 
            : [];
        
        if (quickValues.length > 0) {
            const mappedQuickFilters = quickValues.map(val => FILTER_MAPPINGS.quickFilter?.[val] || val).filter(v => v);
            if (mappedQuickFilters.length > 0) {
                params['flag[]'] = mappedQuickFilters;
            }
        }
    }

    // Log the final params we will send to the API
    try {
        const cleanParams = JSON.parse(JSON.stringify(params));
        console.log('🔧 buildApiParams() -> Final params:', cleanParams);
    } catch (e) {
        console.log('🔧 buildApiParams() -> Final params:', params);
    }
    
    return params;
}

// Fetch products from API
async function fetchProducts() {
    if (isLoading) {
        console.log('⏳ API call already in progress, skipping...');
        return;
    }
    isLoading = true;
    
    try {
        const params = buildApiParams();
        
        // Build the full API URL for logging (matching API spec format)
        const baseUrl = 'https://brandeduk-backend.onrender.com/api/products';
        const queryParts = [];
        
        Object.keys(params).forEach(key => {
            const value = params[key];
            if (value === null || value === undefined || value === '') {
                return;
            }
            
            // Handle array parameters (keys ending with [])
            if (key.endsWith('[]') && Array.isArray(value)) {
                value.forEach(v => {
                    if (v !== null && v !== undefined && v !== '') {
                        queryParts.push(`${key}=${encodeURIComponent(v)}`);
                    }
                });
            } else if (Array.isArray(value)) {
                // If it's an array but key doesn't end with [], add [] to key
                value.forEach(v => {
                    if (v !== null && v !== undefined && v !== '') {
                        queryParts.push(`${key}[]=${encodeURIComponent(v)}`);
                    }
                });
            } else {
                // Single value parameter
                queryParts.push(`${key}=${encodeURIComponent(value)}`);
            }
        });
        
        const queryString = queryParts.join('&');
        const fullUrl = `${baseUrl}${queryString ? '?' + queryString : ''}`;
        
        // Log the API call
        console.log('🚀 API CALL TRIGGERED:', {
            method: 'GET',
            url: fullUrl,
            params: params,
            timestamp: new Date().toISOString()
        });
        
        const data = await BrandedAPI.getProducts(params);
        
        console.log('✅ API RESPONSE RECEIVED:', {
            total: data && data.total,
            itemsCount: (data && data.items && data.items.length) || 0,
            timestamp: new Date().toISOString()
        });
        
        currentState.total = data.total;
        return data.items;
    } catch (error) {
        console.error('❌ ERROR fetching products:', error);
        console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
        });
        return [];
    } finally {
        isLoading = false;
    }
}

// Fetch filter counts
async function fetchFilterCounts() {
    try {
        console.log('🔍 Fetching filter counts...');
        const params = buildApiParams();
        
        // Call /api/products with same parameters to get filter aggregations
        const counts = await BrandedAPI.getFilterCounts(params);
        
        console.log('📊 Filter counts received:', counts);
        updateFilterCounts(counts);
    } catch (error) {
        console.error('❌ Error fetching filter counts:', error);
    }
}

// Update filter counts in sidebar
function updateFilterCounts(counts) {
    if (!counts) return;
    
    // Map API filter names to frontend selectors
    const filterMap = {
        gender: '.filter-checkbox-item input[value]',
        ageGroup: '.filter-checkbox-item input[value]',
        sleeve: '.filter-checkbox-item input[value]',
        neckline: '.filter-checkbox-item input[value]',
        fabric: '.filter-checkbox-item input[value]',
        size: '.filter-checkbox-item input[value]',
        primaryColour: '.filter-checkbox-item input[value]',
        colourShade: '.filter-checkbox-item input[value]',
        style: '.filter-checkbox-item input[value]',
        tag: '.filter-checkbox-item input[value]',
        weight: '.filter-checkbox-item input[value]',
        fit: '.filter-checkbox-item input[value]',
        sector: '.filter-checkbox-item input[value]',
        sport: '.filter-checkbox-item input[value]',
        effect: '.filter-checkbox-item input[value]',
        accreditations: '.filter-checkbox-item input[value]',
        feature: '.filter-checkbox-item input[value]'
    };
    
    // Update counts for each filter type
    Object.keys(counts).forEach(apiFilterName => {
        const filterSection = document.querySelector(`.filter-expandable-row:has(h4:contains('${apiFilterName}'))`);
        if (!filterSection) return;
        
        const filterContent = filterSection.nextElementSibling;
        if (!filterContent || !filterContent.classList.contains('filter-expandable-content')) return;
        
        Object.keys(counts[apiFilterName]).forEach(slug => {
            // Find the checkbox with matching value (may need reverse mapping)
            const checkbox = filterContent.querySelector(`input[value="${slug}"]`);
            if (checkbox) {
                const count = counts[apiFilterName][slug];
                let countSpan = checkbox.parentElement.querySelector('.count');
                if (!countSpan) {
                    countSpan = document.createElement('span');
                    countSpan.className = 'count';
                    checkbox.parentElement.appendChild(countSpan);
                }
                countSpan.textContent = `(${count})`;
            }
        });
    });
}

// Update URL without reload
function updateURL() {
    const url = new URL(window.location);
    url.searchParams.set('category', currentState.category);
    url.searchParams.set('page', currentState.page);
    if (currentState.limit && currentState.limit !== 28) {
        url.searchParams.set('limit', currentState.limit);
    } else {
        url.searchParams.delete('limit');
    }
    if (currentState.sort && currentState.sort !== 'best') {
        url.searchParams.set('sort', currentState.sort);
    } else {
        url.searchParams.delete('sort');
    }
    if (currentState.search) url.searchParams.set('q', currentState.search);
    else url.searchParams.delete('q');
    if (currentState.priceMin !== null) url.searchParams.set('priceMin', currentState.priceMin);
    else url.searchParams.delete('priceMin');
    if (currentState.priceMax !== null) url.searchParams.set('priceMax', currentState.priceMax);
    else url.searchParams.delete('priceMax');
    window.history.replaceState({}, '', url);
}

// Category titles
const categoryTitles = {
    'all': 'All Products',
    'hoodies': 'Hoodies',
    'tshirts': 'T-Shirts',
    'polo': 'Polo Shirts',
    'jackets': 'Jackets',
    'hivis': 'Hi-Vis',
    'fleeces': 'Fleeces',
    'bags': 'Bags',
    'caps': 'Caps',
    'aprons': 'Aprons',
    'beanies': 'Beanies',
    'sustainable': 'Sustainable',
    'trousers': 'Trousers',
    'workwear': 'Workwear'
};

// VAT helpers - uses same key as vat-toggle.js
// NOTA: 'on' nel localStorage = toggle viola = INC VAT = prezzi +20%
function isVatOn() {
    return localStorage.getItem('brandeduk-vat-mode') !== 'on';
}

function formatCurrency(amount) {
    let value = Number(amount) || 0;
    if (isVatOn()) {
        value = value * 1.20;
    }
    return '£' + value.toFixed(2);
}

function vatSuffix() {
    return isVatOn() ? 'inc VAT' : 'ex VAT';
}

function getPriceRange() {
    const prices = PRICE_BREAKS.map(b => b.price);
    return { min: Math.min(...prices), max: Math.max(...prices) };
}

// Render products (now uses API data)
async function renderProducts() {
    const grid = document.getElementById('productsGrid');
    if (!grid) {
        console.error('❌ productsGrid element not found!');
        return;
    }
    
    console.log('🎨 renderProducts() called - updating product grid...');
    
    // Keep current products visible - don't show loading state
    // Store current state to preserve it during fetch
    const currentProductsCount = grid.children.length;
    console.log(`📦 Keeping ${currentProductsCount} current products visible while fetching...`);
    
    // Fetch new products (keep old ones visible)
    const products = await fetchProducts();
    
    console.log(`📦 Received ${products.length} products from API`);
    
    // Update title and count
    const categoryTitleEl = document.getElementById('categoryTitle');
    const productsCountEl = document.getElementById('productsCount');
    
    if (categoryTitleEl) {
        categoryTitleEl.textContent = categoryTitles[currentState.category] || 'Products';
    }
    if (productsCountEl) {
        productsCountEl.textContent = `${currentState.total} products`;
    }
    
    // Update pagination
    updatePagination();
    
    // Now replace the grid with new products (only after data arrives)
    grid.innerHTML = '';
    
    if (products.length === 0) {
        console.log('⚠️ No products found matching criteria');
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">No products found matching your criteria.</div>';
        return;
    }
    
    console.log(`✅ Rendering ${products.length} products to grid...`);
    
    products.forEach((product, index) => {
        // Transform API product to frontend format
        const colors = product.colors || [{ name: 'Default', main: product.image }];
        const colorIndex = index % colors.length;
        const displayColor = colors[colorIndex];
        
        // Get price range from priceBreaks or use base price
        let minPrice = parseFloat(product.price) || 0;
        let maxPrice = minPrice;
        if (product.priceBreaks && product.priceBreaks.length > 0) {
            const prices = product.priceBreaks.map(pb => parseFloat(pb.price)).filter(p => !isNaN(p));
            if (prices.length > 0) {
                minPrice = Math.min(...prices);
                maxPrice = Math.max(...prices);
            }
        }
        const productPrice = minPrice;
        
        const card = document.createElement('div');
        card.className = 'product-card';
        
        // Generate ALL colors for this card
        const colorsHtml = colors.map((c, i) => 
            `<button type="button" class="color-dot ${i === colorIndex ? 'active' : ''}" data-color="${c.name}" data-main="${c.main || c.image_url || product.image}" style="background-image: url('${c.main || c.image_url || product.image}');" title="${c.name}"></button>`
        ).join('');
        
        const visibleColors = 7;
        const progressPercent = Math.min(100, (visibleColors / colors.length) * 100);
        
        // Build badges based on customization types
        let badgesHtml = '';
        if (product.customization && product.customization.includes('embroidery')) {
            badgesHtml += '<span class="badge embroidery">EMBROIDERY</span>';
        }
        if (product.customization && product.customization.includes('print')) {
            badgesHtml += '<span class="badge print">PRINT</span>';
        }
        
        card.innerHTML = `
            <div class="product-media">
                <div class="product-badges">
                    ${badgesHtml}
                </div>
                <img src="${displayColor.main}" alt="${product.name}" class="product-image">
            </div>
            <div class="product-info">
                <div class="product-code-row">
                    <span class="product-code">${product.code}</span>
                    <span class="brand-name">${product.brand}</span>
                </div>
                <div class="product-name">${product.name}</div>
                <div class="product-price" data-price-min="${minPrice}" data-price-max="${maxPrice}">
                    <span class="price-label">From</span>
                    <span class="price-value">${formatCurrency(productPrice)}</span>
                    <span class="price-suffix">${vatSuffix()}</span>
                </div>
                <div class="product-colors-wrapper">
                    <div class="product-colors">${colorsHtml}</div>
                    <div class="color-slider-controls">
                        <button type="button" class="color-arrow color-prev" aria-label="Previous colors">‹</button>
                        <div class="color-progress">
                            <div class="color-progress-bar" style="width: ${progressPercent}%;"></div>
                        </div>
                        <button type="button" class="color-arrow color-next" aria-label="Next colors">›</button>
                    </div>
                </div>
            </div>
        `;
        
        // Color dot interactions
        card.querySelectorAll('.color-dot').forEach(dot => {
            dot.addEventListener('click', (e) => {
                e.stopPropagation();
                const img = card.querySelector('.product-image');
                if (img) img.src = dot.dataset.main;
                card.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                dot.classList.add('active');
            });
        });
        
        // Color slider scroll controls
        const colorsContainer = card.querySelector('.product-colors');
        const prevBtn = card.querySelector('.color-prev');
        const nextBtn = card.querySelector('.color-next');
        const progressBar = card.querySelector('.color-progress-bar');
        const scrollAmount = 120;
        
        if (prevBtn && nextBtn && colorsContainer) {
            prevBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                colorsContainer.scrollLeft -= scrollAmount;
            });
            
            nextBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                colorsContainer.scrollLeft += scrollAmount;
            });
            
            // Update progress bar on scroll
            colorsContainer.addEventListener('scroll', () => {
                const maxScroll = colorsContainer.scrollWidth - colorsContainer.clientWidth;
                const progress = maxScroll > 0 ? ((colorsContainer.scrollLeft + colorsContainer.clientWidth) / colorsContainer.scrollWidth) * 100 : 100;
                if (progressBar) progressBar.style.width = progress + '%';
            });
        }
        
        // Card click - go to product detail
        card.addEventListener('click', () => {
            sessionStorage.setItem('selectedProduct', product.code);
            sessionStorage.setItem('selectedProductData', JSON.stringify(product));
            const activeColor = card.querySelector('.color-dot.active');
            if (activeColor) {
                sessionStorage.setItem('selectedColorName', activeColor.dataset.color);
                sessionStorage.setItem('selectedColorUrl', activeColor.dataset.main);
            }
            // Navigate to product detail page
            window.location.href = '../product-detail.html?code=' + product.code;
        });
        
        grid.appendChild(card);
    });
    
    console.log(`✅ Successfully rendered ${products.length} products to grid!`);
}

// Toggle switch functionality for special filters
document.querySelectorAll('.filter-toggle-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const isPressed = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', !isPressed);
        
        // Initialize quickFilters if not exists
        if (!currentState.filters.quickFilters) {
            currentState.filters.quickFilters = [];
        }
        
        // Map button classes to filter values (matching API spec)
        const filterValueMap = {
            'toggle-new-in': 'new-in',
            'toggle-bradeal': 'bradeal',
            'toggle-offers': 'offers',
            'toggle-in-stock': 'in-stock',
            'toggle-recycled': 'recycled'
            // Note: 'toggle-plus-sizes' not in API spec, so not mapped
        };
        
        // Find the filter value for this button
        let filterValue = null;
        for (const [className, value] of Object.entries(filterValueMap)) {
            if (btn.classList.contains(className)) {
                filterValue = value;
                break;
            }
        }
        
        if (filterValue) {
            console.log('🔘 QUICK FILTER TOGGLE CLICKED:', {
                filterValue: filterValue,
                isPressed: isPressed,
                willBeActive: !isPressed,
                timestamp: new Date().toISOString()
            });
            
            if (!isPressed) {
                // Add filter
                if (!currentState.filters.quickFilters.includes(filterValue)) {
                    currentState.filters.quickFilters.push(filterValue);
                }
            } else {
                // Remove filter
                currentState.filters.quickFilters = currentState.filters.quickFilters.filter(v => v !== filterValue);
            }
            
            console.log('📊 QUICK FILTER STATE UPDATED:', {
                quickFilters: currentState.filters.quickFilters,
                fullState: JSON.parse(JSON.stringify(currentState.filters))
            });
            
            // Build API params to show what will be sent
            const apiParams = buildApiParams();
            console.log('📤 API PARAMS BUILT:', apiParams);
            
            // Reset to page 1 and fetch new products
            currentState.page = 1;
            updateURL();
            
            console.log('🔄 Calling renderProducts() to trigger API call...');
            await renderProducts();
            await fetchFilterCounts();
        }
    });
});

// Clear All button functionality
document.querySelector('.clear-all-btn')?.addEventListener('click', async function() {
    // Reset all toggle switches to OFF
    document.querySelectorAll('.filter-toggle-btn').forEach(btn => {
        btn.setAttribute('aria-pressed', 'false');
    });
    
    // Reset all checkboxes
    document.querySelectorAll('.filter-checkbox-item input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset state
    currentState.page = 1;
    currentState.search = '';
    currentState.priceMin = null;
    currentState.priceMax = null;
    Object.keys(currentState.filters).forEach(key => {
        currentState.filters[key] = [];
    });
    
    // Reset quick filters
    currentState.filters.quickFilters = [];
    
    // Clear search input
    const searchInput = document.querySelector('.filter-search');
    if (searchInput) searchInput.value = '';
    
    // Close Special Filters dropdown
    const specialFilters = document.querySelector('.special-filters-dropdown');
    if (specialFilters) specialFilters.classList.remove('open');
    
    // Reset price range (will be updated after fetching products)
    updateURL();
    await renderProducts();
    await fetchFilterCounts();
    initPriceRangeSlider();
});

// Listen for VAT state changes from main.js (legacy)
document.addEventListener('vatStateChanged', function(e) {
    renderProducts(); // Re-render products with new VAT prices
    updatePriceRangeDisplay();
});

// Listen for VAT state changes from vat-toggle.js
document.addEventListener('brandeduk:vat-change', function(e) {
    renderProducts(); // Re-render products with new VAT prices
    updatePriceRangeDisplay();
});

// Dual Price Range Slider
async function initPriceRangeSlider() {
    // #region agent log
    fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2698',message:'initPriceRangeSlider ENTRY',data:{timestamp:Date.now()},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    console.log('🎚️ Initializing price range slider...');
    const sliderMin = document.getElementById('priceSliderMin');
    const sliderMax = document.getElementById('priceSliderMax');
    const rangeSelected = document.getElementById('priceRangeSelected');
    const rangeDisplay = document.getElementById('priceRangeDisplay');
    const inputMin = document.getElementById('priceInputMin');
    const inputMax = document.getElementById('priceInputMax');
    
    // #region agent log
    fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2707',message:'Element existence check',data:{sliderMinExists:!!sliderMin,sliderMaxExists:!!sliderMax,sliderMinId:sliderMin?.id,sliderMaxId:sliderMax?.id},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
    // #endregion
    
    if (!sliderMin || !sliderMax) {
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2708',message:'Sliders NOT FOUND - early return',data:{sliderMin:!!sliderMin,sliderMax:!!sliderMax},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
        // #endregion
        console.error('❌ Price sliders not found!', { sliderMin: !!sliderMin, sliderMax: !!sliderMax });
        return;
    }
    
    // #region agent log
    fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2712',message:'Sliders found - continuing',data:{sliderMinDisabled:sliderMin.disabled,sliderMaxDisabled:sliderMax.disabled,sliderMinPointerEvents:getComputedStyle(sliderMin).pointerEvents,sliderMaxPointerEvents:getComputedStyle(sliderMax).pointerEvents},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
    // #endregion
    console.log('✅ Price sliders found');
    
    // Declare variables in function scope
    let catalogMinPrice = 14;
    let catalogMaxPrice = 65;
    let priceUpdateTimeout;
    
    // Fetch price range from API (without filters to get full range)
    try {
        console.log('📡 Fetching price range from API...');
        const params = { limit: 1 }; // Just to get priceRange metadata
        const data = await BrandedAPI.getProducts(params);
        const priceRange = data.priceRange || { min: 14, max: 65 };
        
        catalogMinPrice = Math.floor(priceRange.min || 14);
        catalogMaxPrice = Math.ceil(priceRange.max || 65);
        console.log('✅ Price range fetched:', { catalogMinPrice, catalogMaxPrice });
        
    sliderMin.disabled = false;
    sliderMax.disabled = false;
    
    // Update slider attributes dynamically
    sliderMin.min = catalogMinPrice;
    sliderMin.max = catalogMaxPrice;
    sliderMax.min = catalogMinPrice;
    sliderMax.max = catalogMaxPrice;
        
        // Initialize slider values from URL params or use full range (but don't set state unless in URL)
        const urlPriceMin = urlParams.get('priceMin');
        const urlPriceMax = urlParams.get('priceMax');
        
        if (urlPriceMin && !isNaN(parseFloat(urlPriceMin))) {
            currentState.priceMin = Math.max(catalogMinPrice, Math.min(catalogMaxPrice, parseFloat(urlPriceMin)));
            sliderMin.value = currentState.priceMin;
        } else {
            // Don't set state, just set slider to full range for display
            sliderMin.value = catalogMinPrice;
            currentState.priceMin = null; // Keep null so API doesn't filter by price
        }
        
        if (urlPriceMax && !isNaN(parseFloat(urlPriceMax))) {
            currentState.priceMax = Math.max(catalogMinPrice, Math.min(catalogMaxPrice, parseFloat(urlPriceMax)));
            sliderMax.value = currentState.priceMax;
        } else {
            // Don't set state, just set slider to full range for display
            sliderMax.value = catalogMaxPrice;
            currentState.priceMax = null; // Keep null so API doesn't filter by price
        }
        
        console.log('✅ Slider values initialized:', { 
            minValue: sliderMin.value, 
            maxValue: sliderMax.value,
            minRange: catalogMinPrice,
            maxRange: catalogMaxPrice,
            statePriceMin: currentState.priceMin,
            statePriceMax: currentState.priceMax
        });
        
    } catch (error) {
        console.error('❌ Error initializing price slider:', error);
        // Use defaults
        catalogMinPrice = 14;
        catalogMaxPrice = 65;
        currentState.priceMin = catalogMinPrice;
        currentState.priceMax = catalogMaxPrice;
        sliderMin.min = catalogMinPrice;
        sliderMin.max = catalogMaxPrice;
        sliderMax.min = catalogMinPrice;
        sliderMax.max = catalogMaxPrice;
        sliderMin.value = catalogMinPrice;
        sliderMax.value = catalogMaxPrice;
    }
    
    function updateSlider(triggerAPI = false) {
        console.log('🎚️ updateSlider() called', { triggerAPI });
        let minVal = parseInt(sliderMin.value);
        let maxVal = parseInt(sliderMax.value);

        console.log('🎚️ Slider values:', { minVal, maxVal, catalogMinPrice, catalogMaxPrice });

        if (!Number.isFinite(minVal) || !Number.isFinite(maxVal)) {
            console.warn('⚠️ Invalid slider values:', { minVal, maxVal });
            return;
        }
        
        // Prevent crossing
        if (minVal > maxVal) {
            const temp = minVal;
            minVal = maxVal;
            maxVal = temp;
            sliderMin.value = minVal;
            sliderMax.value = maxVal;
        }
        
        // Update selected range bar
        const percentMin = ((minVal - catalogMinPrice) / (catalogMaxPrice - catalogMinPrice)) * 100;
        const percentMax = ((maxVal - catalogMinPrice) / (catalogMaxPrice - catalogMinPrice)) * 100;
        if (rangeSelected) {
        rangeSelected.style.left = percentMin + '%';
        rangeSelected.style.width = (percentMax - percentMin) + '%';
        }
        
        // Update display with VAT
        const vatMultiplier = isVatOn() ? 1.20 : 1;
        const displayMin = (minVal * vatMultiplier).toFixed(2);
        const displayMax = (maxVal * vatMultiplier).toFixed(2);
        if (rangeDisplay) {
        rangeDisplay.textContent = '£' + displayMin + ' - £' + displayMax;
        }
        
        // Update inputs
        if (inputMin) inputMin.value = '£' + minVal;
        if (inputMax) inputMax.value = '£' + maxVal;
        
        // Update state immediately
        currentState.priceMin = minVal;
        currentState.priceMax = maxVal;
        
        console.log('💰 Price state updated:', { priceMin: currentState.priceMin, priceMax: currentState.priceMax });
        
        // Always clear any pending timeout
        clearTimeout(priceUpdateTimeout);
        
        // Trigger API call
        if (triggerAPI) {
            // Immediate API call (for change events)
            currentState.page = 1;
            updateURL();
            console.log('💰 Triggering IMMEDIATE API call with price range:', { priceMin: minVal, priceMax: maxVal });
            console.log('📤 Current state before API call:', JSON.parse(JSON.stringify(currentState)));
            renderProducts().then(() => {
                console.log('✅ renderProducts() completed');
            }).catch(err => {
                console.error('❌ Error in renderProducts():', err);
            });
            fetchFilterCounts().then(() => {
                console.log('✅ fetchFilterCounts() completed');
            }).catch(err => {
                console.error('❌ Error in fetchFilterCounts():', err);
            });
        } else {
            // Debounced API call (for input events while dragging)
        priceUpdateTimeout = setTimeout(async () => {
                console.log('💰 Price filter changed (debounced), fetching products...', { priceMin: minVal, priceMax: maxVal });
                console.log('📤 Current state before API call:', JSON.parse(JSON.stringify(currentState)));
        currentState.page = 1;
        updateURL();
                try {
            await renderProducts();
                    console.log('✅ renderProducts() completed (debounced)');
                } catch (err) {
                    console.error('❌ Error in renderProducts() (debounced):', err);
                }
                try {
            await fetchFilterCounts();
                    console.log('✅ fetchFilterCounts() completed (debounced)');
                } catch (err) {
                    console.error('❌ Error in fetchFilterCounts() (debounced):', err);
                }
        }, 500); // Debounce 500ms while dragging
            console.log('⏳ Debounced API call scheduled (500ms delay)');
        }
    }
    
    // Track last values to detect changes
    let lastMinVal = parseInt(sliderMin.value);
    let lastMaxVal = parseInt(sliderMax.value);
    
    // Function to check if slider values changed and trigger API
    function checkAndTriggerAPI() {
        const currentMin = parseInt(sliderMin.value);
        const currentMax = parseInt(sliderMax.value);
        
        if (currentMin !== lastMinVal || currentMax !== lastMaxVal) {
            console.log('🔄 Slider values changed:', {
                old: { min: lastMinVal, max: lastMaxVal },
                new: { min: currentMin, max: currentMax }
            });
            lastMinVal = currentMin;
            lastMaxVal = currentMax;
            updateSlider(true); // Always trigger API when values change
        }
    }
    
    // Update UI and trigger debounced API call on slider movement (while dragging)
    console.log('🔧 Attaching price slider event listeners...');
    
    // #region agent log
    fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2897',message:'About to attach event listeners',data:{sliderMinType:typeof sliderMin,sliderMaxType:typeof sliderMax,sliderMinIsElement:sliderMin instanceof Element,sliderMaxIsElement:sliderMax instanceof Element},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
    // #endregion
    
    // Input event - fires while dragging (debounced)
    try {
    sliderMin.addEventListener('input', () => {
            // #region agent log
            fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2900',message:'sliderMin input EVENT FIRED',data:{value:sliderMin.value,type:'input'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            console.log('🎚️ sliderMin input event fired, value:', sliderMin.value);
            updateSlider(false); // Debounced API call while dragging
        });
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2903',message:'sliderMin input listener ATTACHED',data:{success:true},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
        // #endregion
    } catch (e) {
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2903',message:'ERROR attaching sliderMin input listener',data:{error:e.message,stack:e.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
        // #endregion
        console.error('Error attaching sliderMin input listener:', e);
    }
    
    try {
    sliderMax.addEventListener('input', () => {
            // #region agent log
            fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2904',message:'sliderMax input EVENT FIRED',data:{value:sliderMax.value,type:'input'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            console.log('🎚️ sliderMax input event fired, value:', sliderMax.value);
            updateSlider(false); // Debounced API call while dragging
        });
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2907',message:'sliderMax input listener ATTACHED',data:{success:true},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
        // #endregion
    } catch (e) {
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2907',message:'ERROR attaching sliderMax input listener',data:{error:e.message,stack:e.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
        // #endregion
        console.error('Error attaching sliderMax input listener:', e);
    }
    
    // Change event - fires when slider is released (immediate)
    try {
    sliderMin.addEventListener('change', () => {
            // #region agent log
            fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2910',message:'sliderMin change EVENT FIRED',data:{value:sliderMin.value,type:'change'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            console.log('🎚️ sliderMin change event fired, value:', sliderMin.value);
            checkAndTriggerAPI(); // Check and trigger API
        });
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2913',message:'sliderMin change listener ATTACHED',data:{success:true},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
        // #endregion
    } catch (e) {
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2913',message:'ERROR attaching sliderMin change listener',data:{error:e.message,stack:e.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
        // #endregion
        console.error('Error attaching sliderMin change listener:', e);
    }
    
    try {
    sliderMax.addEventListener('change', () => {
            // #region agent log
            fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2915',message:'sliderMax change EVENT FIRED',data:{value:sliderMax.value,type:'change'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            console.log('🎚️ sliderMax change event fired, value:', sliderMax.value);
            checkAndTriggerAPI(); // Check and trigger API
        });
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2918',message:'sliderMax change listener ATTACHED',data:{success:true},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
        // #endregion
    } catch (e) {
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2918',message:'ERROR attaching sliderMax change listener',data:{error:e.message,stack:e.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
        // #endregion
        console.error('Error attaching sliderMax change listener:', e);
    }
    
    // Mouseup event - backup to ensure API call when slider is released
    try {
        sliderMin.addEventListener('mouseup', () => {
            // #region agent log
            fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2921',message:'sliderMin mouseup EVENT FIRED',data:{value:sliderMin.value,type:'mouseup'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            console.log('🎚️ sliderMin mouseup event fired, value:', sliderMin.value);
            setTimeout(() => {
                checkAndTriggerAPI();
            }, 50);
        });
        sliderMax.addEventListener('mouseup', () => {
            // #region agent log
            fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2928',message:'sliderMax mouseup EVENT FIRED',data:{value:sliderMax.value,type:'mouseup'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            console.log('🎚️ sliderMax mouseup event fired, value:', sliderMax.value);
            setTimeout(() => {
                checkAndTriggerAPI();
            }, 50);
        });
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2933',message:'mouseup listeners ATTACHED',data:{success:true},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
        // #endregion
    } catch (e) {
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2933',message:'ERROR attaching mouseup listeners',data:{error:e.message,stack:e.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
        // #endregion
        console.error('Error attaching mouseup listeners:', e);
    }
    
    // Touch end for mobile devices
    try {
        sliderMin.addEventListener('touchend', () => {
            // #region agent log
            fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2936',message:'sliderMin touchend EVENT FIRED',data:{value:sliderMin.value,type:'touchend'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            console.log('🎚️ sliderMin touchend event fired, value:', sliderMin.value);
            setTimeout(() => {
                checkAndTriggerAPI();
            }, 50);
        });
        sliderMax.addEventListener('touchend', () => {
            // #region agent log
            fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2943',message:'sliderMax touchend EVENT FIRED',data:{value:sliderMax.value,type:'touchend'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            console.log('🎚️ sliderMax touchend event fired, value:', sliderMax.value);
            setTimeout(() => {
                checkAndTriggerAPI();
            }, 50);
        });
    } catch (e) {
        console.error('Error attaching touchend listeners:', e);
    }
    
    // #region agent log
    fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:2949',message:'All event listeners attachment complete',data:{success:true},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    console.log('✅ All price slider event listeners attached');
    
    // Input field handlers - trigger API on change
        if (inputMin) {
    inputMin.addEventListener('change', function() {
            let val = parseInt(this.value.replace('£', '').replace(/[^0-9]/g, ''));
        if (isNaN(val)) val = catalogMinPrice;
        val = Math.max(catalogMinPrice, Math.min(val, parseInt(sliderMax.value)));
        sliderMin.value = val;
            updateSlider(true); // Trigger API immediately
    });
        }
    
        if (inputMax) {
    inputMax.addEventListener('change', function() {
            let val = parseInt(this.value.replace('£', '').replace(/[^0-9]/g, ''));
        if (isNaN(val)) val = catalogMaxPrice;
        val = Math.min(catalogMaxPrice, Math.max(val, parseInt(sliderMin.value)));
        sliderMax.value = val;
            updateSlider(true); // Trigger API immediately
        });
    }
    
    // Initialize display (without triggering API on initial load)
    updateSlider(false);
    // #region agent log
    fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:3071',message:'initPriceRangeSlider EXIT - function complete',data:{sliderMinValue:sliderMin.value,sliderMaxValue:sliderMax.value,statePriceMin:currentState.priceMin,statePriceMax:currentState.priceMax},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    console.log('✅ Price slider initialization complete');
    console.log('📊 Final slider state:', {
        sliderMinValue: sliderMin.value,
        sliderMaxValue: sliderMax.value,
        statePriceMin: currentState.priceMin,
        statePriceMax: currentState.priceMax,
        catalogRange: { min: catalogMinPrice, max: catalogMaxPrice }
    });
}

function updatePriceRangeDisplay() {
    const sliderMin = document.getElementById('priceSliderMin');
    const sliderMax = document.getElementById('priceSliderMax');
    const rangeDisplay = document.getElementById('priceRangeDisplay');
    
    if (!sliderMin || !sliderMax || !rangeDisplay) return;
    
    const rawMin = parseInt(sliderMin.value);
    const rawMax = parseInt(sliderMax.value);
    if (!Number.isFinite(rawMin) || !Number.isFinite(rawMax)) return;

    const vatMultiplier = isVatOn() ? 1.20 : 1;
    const displayMin = (rawMin * vatMultiplier).toFixed(2);
    const displayMax = (rawMax * vatMultiplier).toFixed(2);
    rangeDisplay.textContent = '£' + displayMin + ' - £' + displayMax;
}

// Filter checkbox handlers
function setupFilterCheckboxes() {
    console.log('🔧 Setting up filter checkboxes...');
    
    // Setup expandable filter rows
    const expandableRows = document.querySelectorAll('.filter-expandable-row');
    console.log(`📋 Found ${expandableRows.length} expandable filter rows`);
    
    expandableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Toggle expanded state when clicking on the row (h4, span, or row itself)
            // Checkboxes are in sibling .filter-expandable-content, so they won't trigger this
            this.classList.toggle('expanded');
        });
    });

    // Map filter section headers to state keys and API param names
    const filterMap = {
        'Gender': 'gender',
        'Age Group': 'ageGroup',
        'Sleeve': 'sleeve',
        'Neckline': 'neckline',
        'Accreditations': 'accreditations',
        'Primary Colour': 'primaryColour',
        'Colour Shade': 'colourShade',
        'Style': 'style',
        'Features': 'feature', // Note: singular for API
        'Size': 'size',
        'Fabric': 'fabric',
        'Weight (GSM)': 'weight',
        'Fit': 'fit',
        'Related Sector': 'sector',
        'Related Sport': 'sport',
        'Tag': 'tag',
        'Effect': 'effect'
    };
    
    // For each expandable row, find its h4 and map to filter key
    document.querySelectorAll('.filter-expandable-row').forEach(row => {
        const h4 = row.querySelector('h4');
        if (!h4) return;
        
        const headerText = h4.textContent.trim();
        const filterKey = filterMap[headerText];
        if (!filterKey) return;
        
        // Find the content div that follows this row
        let content = row.nextElementSibling;
        if (!content || !content.classList.contains('filter-expandable-content')) return;
        
        // Setup checkboxes in this content section
        const checkboxes = content.querySelectorAll('input[type="checkbox"]');
        console.log(`  ✓ ${headerText}: Found ${checkboxes.length} checkboxes`);
        
        checkboxes.forEach((checkbox, index) => {
            // Check if event listener already attached (avoid duplicates)
            if (checkbox.dataset.listenerAttached === 'true') {
                return;
            }
            checkbox.dataset.listenerAttached = 'true';
            
            checkbox.addEventListener('change', async (e) => {
                e.stopPropagation();
                
                console.log('🔘 FILTER CHECKBOX CLICKED:', {
                    filterKey: filterKey,
                    checkboxValue: checkbox.value,
                    isChecked: checkbox.checked,
                    timestamp: new Date().toISOString()
                });
                
                // Collect all checked values for this filter
                const checkedBoxes = Array.from(content.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                
                // Update currentState.filters[filterKey] - store as array
                if (checkedBoxes.length > 0) {
                currentState.filters[filterKey] = checkedBoxes;
                } else {
                    // Clear filter if no boxes checked
                    currentState.filters[filterKey] = [];
                }
                
                console.log('📊 FILTER STATE UPDATED:', {
                    filterKey: filterKey,
                    checkedValues: checkedBoxes,
                    fullState: JSON.parse(JSON.stringify(currentState.filters))
                });
                
                // Build API params to show what will be sent
                const apiParams = buildApiParams();
                console.log('📤 API PARAMS BUILT:', apiParams);
                
                // Reset to page 1 and fetch new products
                currentState.page = 1;
                updateURL();
                
                console.log('🔄 Calling renderProducts() to trigger API call...');
                try {
                await renderProducts();
                await fetchFilterCounts();
                    console.log('✅ Products updated successfully!');
                } catch (error) {
                    console.error('❌ Error updating products:', error);
                }
            });
        });
    });
    
    console.log('✅ Filter checkboxes setup complete!');
    console.log('📝 To test: Click any filter checkbox and check the console for API call logs');
}

// Search input handler
function setupSearchInput() {
    const searchInput = document.querySelector('.filter-search');
    if (searchInput) {
        // Only trigger API call on Enter key press
        searchInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                currentState.search = e.target.value.trim();
                currentState.page = 1;
                updateURL();
                await renderProducts();
                await fetchFilterCounts();
            }
        });
        
        // Also allow clearing search on Escape
        searchInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Escape') {
                e.target.value = '';
                currentState.search = '';
                currentState.page = 1;
                updateURL();
                await renderProducts();
                await fetchFilterCounts();
            }
        });
    }
    
    // Header search input
    const headerSearch = document.getElementById('searchbarHeaderInput');
    if (headerSearch) {
        headerSearch.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                currentState.search = e.target.value.trim();
                currentState.page = 1;
                updateURL();
                await renderProducts();
                await fetchFilterCounts();
            }
        });
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
    console.log('🚀 Page loaded, initializing filters and products...');
    
    // Initialize filters first
    setupFilterCheckboxes();
    setupSearchInput();
    
    // Verify filter checkboxes are set up
    const totalCheckboxes = document.querySelectorAll('.filter-checkbox-item input[type="checkbox"]').length;
    console.log(`✅ Found ${totalCheckboxes} filter checkboxes, event handlers attached`);
    
    // Load initial products
    await renderProducts();
    await fetchFilterCounts();
    // #region agent log
    fetch('http://127.0.0.1:7244/ingest/ff4bdadc-0eae-4978-b238-71d56c718ed8',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'shop-pc.html:3274',message:'About to CALL initPriceRangeSlider',data:{documentReady:document.readyState},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    await initPriceRangeSlider();
    
    // Update prices when VAT changes
    window.addEventListener('vatToggleChanged', () => {
        updatePrices();
        updatePriceRangeDisplay();
    });
    
    console.log('✅ Initialization complete!');
});

// Update prices on VAT change
function updatePrices() {
    document.querySelectorAll('.product-price').forEach(priceEl => {
        const min = Number(priceEl.dataset.priceMin);
        const max = Number(priceEl.dataset.priceMax);
        const valueEl = priceEl.querySelector('.price-value');
        if (valueEl && Number.isFinite(min)) {
            valueEl.textContent = formatCurrency(min);
        }
        const suffixEl = priceEl.querySelector('.price-suffix');
        if (suffixEl) {
            suffixEl.textContent = vatSuffix();
        }
    });
}

// Pagination functions
function updatePagination() {
    const paginationTop = document.getElementById('paginationTop');
    const paginationContainer = document.getElementById('paginationContainer');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const currentPageSpan = document.getElementById('currentPage');
    const totalPagesSpan = document.getElementById('totalPages');
    
    const totalPages = Math.ceil(currentState.total / currentState.limit);
    
    // Update old pagination (keep for backward compatibility, but hide it)
    if (paginationContainer) {
        paginationContainer.style.display = 'none';
    if (currentPageSpan) currentPageSpan.textContent = currentState.page;
    if (totalPagesSpan) totalPagesSpan.textContent = totalPages;
        if (prevBtn) prevBtn.disabled = currentState.page === 1;
        if (nextBtn) nextBtn.disabled = currentState.page === totalPages || totalPages === 0;
    }
    
    // Update new pagination (inline in header)
    if (!paginationTop) return;
    
    const firstBtn = document.getElementById('paginationFirst');
    const prevTopBtn = document.getElementById('paginationPrev');
    const nextTopBtn = document.getElementById('paginationNext');
    const lastBtn = document.getElementById('paginationLast');
    const pageNumbersContainer = document.getElementById('paginationPageNumbers');
    
    if (totalPages <= 1) {
        paginationTop.style.display = 'none';
        return;
    }
    
    paginationTop.style.display = 'flex';
    
    // Enable/disable navigation buttons
    if (firstBtn) firstBtn.disabled = currentState.page === 1;
    if (prevTopBtn) prevTopBtn.disabled = currentState.page === 1;
    if (nextTopBtn) nextTopBtn.disabled = currentState.page === totalPages;
    if (lastBtn) lastBtn.disabled = currentState.page === totalPages;
    
    // Render page numbers (show current page and adjacent pages)
    if (pageNumbersContainer) {
        pageNumbersContainer.innerHTML = '';
        
        // Show current page in black circle
        const currentPageBtn = document.createElement('button');
        currentPageBtn.type = 'button';
        currentPageBtn.className = 'pagination-page active';
        currentPageBtn.textContent = currentState.page;
        currentPageBtn.setAttribute('aria-current', 'page');
        pageNumbersContainer.appendChild(currentPageBtn);
    }
}

// Pagination button handlers
document.addEventListener('DOMContentLoaded', function() {
    // Old pagination buttons (keep for backward compatibility)
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', async () => {
            if (currentState.page > 1) {
                currentState.page--;
                updateURL();
                await renderProducts();
                await fetchFilterCounts();
                updatePagination();
                document.getElementById('productsGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', async () => {
            const totalPages = Math.ceil(currentState.total / currentState.limit);
            if (currentState.page < totalPages) {
                currentState.page++;
                updateURL();
                await renderProducts();
                await fetchFilterCounts();
                updatePagination();
                document.getElementById('productsGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }
    
    // New pagination buttons (top right style)
    const firstBtn = document.getElementById('paginationFirst');
    const prevTopBtn = document.getElementById('paginationPrev');
    const nextTopBtn = document.getElementById('paginationNext');
    const lastBtn = document.getElementById('paginationLast');
    
    async function handlePaginationClick(newPage) {
        currentState.page = newPage;
        updateURL();
        await renderProducts();
        await fetchFilterCounts();
        updatePagination();
        document.getElementById('productsGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    if (firstBtn) {
        firstBtn.addEventListener('click', async () => {
            if (currentState.page > 1) {
                await handlePaginationClick(1);
            }
        });
    }
    
    if (prevTopBtn) {
        prevTopBtn.addEventListener('click', async () => {
            if (currentState.page > 1) {
                await handlePaginationClick(currentState.page - 1);
            }
        });
    }
    
    if (nextTopBtn) {
        nextTopBtn.addEventListener('click', async () => {
            const totalPages = Math.ceil(currentState.total / currentState.limit);
            if (currentState.page < totalPages) {
                await handlePaginationClick(currentState.page + 1);
            }
        });
    }
    
    if (lastBtn) {
        lastBtn.addEventListener('click', async () => {
            const totalPages = Math.ceil(currentState.total / currentState.limit);
            if (currentState.page < totalPages) {
                await handlePaginationClick(totalPages);
            }
        });
    }
    
    // Sort By dropdown handler
    const sortSelect = document.getElementById('sortSelect');
    if (sortSelect) {
        // Initialize from currentState
        sortSelect.value = currentState.sort || 'best';
        
        sortSelect.addEventListener('change', async (e) => {
            currentState.sort = e.target.value;
            currentState.page = 1; // Reset to first page when sorting changes
            updateURL();
            await renderProducts();
            await fetchFilterCounts();
            updatePagination();
        });
    }
    
    // View per page dropdown handler
    const viewSelect = document.getElementById('viewSelect');
    if (viewSelect) {
        // Initialize from currentState
        viewSelect.value = currentState.limit || 28;
        
        viewSelect.addEventListener('change', async (e) => {
            currentState.limit = parseInt(e.target.value);
            currentState.page = 1; // Reset to first page when limit changes
            updateURL();
            await renderProducts();
            await fetchFilterCounts();
            updatePagination();
        });
    }
});
</script>

<!-- Account Panel Overlay -->
<div class="account-overlay" id="accountOverlay"></div>

<!-- Account Sign In / Sign Up Panel -->
<div class="account-panel" id="accountPanel">
    <div class="account-panel-header">
        <button class="account-close-btn" id="accountCloseBtn" aria-label="Close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <div class="account-forms-container">
        <div class="account-arrow" id="accountArrow">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </div>
        <div class="account-forms-wrapper">
            <div class="account-form-holder signin-form" id="signinForm">
                <div class="account-form-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span>Sign In</span>
                </div>
                <div class="account-form-content">
                    <form id="signinFormData">
                        <div class="account-input-group">
                            <input type="email" id="signinEmail" required>
                            <label for="signinEmail">Email</label>
                        </div>
                        <div class="account-input-group">
                            <input type="password" id="signinPassword" required>
                            <label for="signinPassword">Password</label>
                        </div>
                        <div class="account-form-actions">
                            <button type="submit" class="account-submit-btn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                    <polyline points="12 5 19 12 12 19"></polyline>
                                </svg>
                            </button>
                        </div>
                        <a href="#" class="account-forgot-link">Forgot Password?</a>
                    </form>
                </div>
            </div>
            <div class="account-form-holder signup-form" id="signupForm">
                <div class="account-form-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="17" y1="11" x2="23" y2="11"></line>
                    </svg>
                    <span>Sign Up</span>
                </div>
                <div class="account-form-content">
                    <form id="signupFormData">
                        <div class="account-input-row">
                            <div class="account-input-group half">
                                <input type="text" id="signupFirstName" required>
                                <label for="signupFirstName">First Name</label>
                            </div>
                            <div class="account-input-group half">
                                <input type="text" id="signupLastName" required>
                                <label for="signupLastName">Last Name</label>
                            </div>
                        </div>
                        <div class="account-input-group">
                            <input type="email" id="signupEmail" required>
                            <label for="signupEmail">Email</label>
                        </div>
                        <div class="account-input-group">
                            <input type="tel" id="signupPhone" required>
                            <label for="signupPhone">Phone Number</label>
                        </div>
                        <div class="account-input-group">
                            <input type="text" id="signupCompany">
                            <label for="signupCompany">Company Name (optional)</label>
                        </div>
                        <div class="account-input-group">
                            <input type="password" id="signupPassword" required>
                            <label for="signupPassword">Password</label>
                        </div>
                        <div class="account-form-actions">
                            <button type="submit" class="account-submit-btn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                    <polyline points="12 5 19 12 12 19"></polyline>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="account-logged-in" id="accountLoggedIn" style="display: none;">
        <div class="account-user-avatar">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#8455f4" stroke-width="1">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 14c-2.5 0-4.5-2-4.5-4.5S9.5 5 12 5s4.5 2 4.5 4.5S14.5 14 12 14z"/>
                <path d="M4.5 19.5c0-3 3.5-5 7.5-5s7.5 2 7.5 5"/>
            </svg>
        </div>
        <h3 class="account-user-name" id="accountUserName">Welcome!</h3>
        <p class="account-user-email" id="accountUserEmail"></p>
        <div class="account-user-details" id="accountUserDetails"></div>
        <button class="account-logout-btn" id="accountLogoutBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Sign Out
        </button>
    </div>
</div>

<!-- Account Panel JS -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const accountBtn = document.getElementById('accountBtn');
    const accountPanel = document.getElementById('accountPanel');
    const accountOverlay = document.getElementById('accountOverlay');
    const accountCloseBtn = document.getElementById('accountCloseBtn');
    const accountArrow = document.getElementById('accountArrow');
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    const signinFormData = document.getElementById('signinFormData');
    const signupFormData = document.getElementById('signupFormData');
    const accountLoggedIn = document.getElementById('accountLoggedIn');
    const accountLogoutBtn = document.getElementById('accountLogoutBtn');
    
    if (!accountBtn || !accountPanel) return;
    
    const USER_SESSION_KEY = 'brandeduk-user-session';
    
    function checkLoggedIn() {
        const session = localStorage.getItem(USER_SESSION_KEY);
        if (session) {
            const user = JSON.parse(session);
            showLoggedInView(user);
            return true;
        }
        return false;
    }
    
    function showLoggedInView(user) {
        document.querySelector('.account-forms-container').style.display = 'none';
        accountLoggedIn.style.display = 'block';
        document.getElementById('accountUserName').textContent = `Welcome, ${user.firstName}!`;
        document.getElementById('accountUserEmail').textContent = user.email;
        document.getElementById('accountUserDetails').innerHTML = `
            <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
            <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
            <p><strong>Company:</strong> ${user.company || 'Not provided'}</p>
        `;
    }
    
    function showFormsView() {
        document.querySelector('.account-forms-container').style.display = 'flex';
        accountLoggedIn.style.display = 'none';
    }
    
    function openPanel() {
        checkLoggedIn();
        accountPanel.classList.add('active');
        accountOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closePanel() {
        accountPanel.classList.remove('active');
        accountOverlay.classList.remove('active');
        document.body.style.overflow = '';
        resetForms();
    }
    
    function resetForms() {
        signinForm.classList.remove('active', 'inactive');
        signupForm.classList.remove('active', 'inactive');
        accountArrow.classList.remove('visible');
    }
    
    accountBtn.addEventListener('click', (e) => {
        e.preventDefault();
        openPanel();
    });

    const headerSignInLink = document.getElementById('headerSignInLink');
    const headerRegisterLink = document.getElementById('headerRegisterLink');
    const headerMyAccountLink = document.getElementById('headerMyAccountLink');

    if (headerSignInLink) {
        headerSignInLink.addEventListener('click', (e) => {
            e.preventDefault();
            openPanel();
            setTimeout(() => {
                signinForm.classList.add('active');
                signinForm.classList.remove('inactive');
                signupForm.classList.add('inactive');
                signupForm.classList.remove('active');
                accountArrow.classList.add('visible');
            }, 100);
        });
    }

    if (headerRegisterLink) {
        headerRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            openPanel();
            setTimeout(() => {
                signupForm.classList.add('active');
                signupForm.classList.remove('inactive');
                signinForm.classList.add('inactive');
                signinForm.classList.remove('active');
                accountArrow.classList.add('visible');
            }, 100);
        });
    }

    if (headerMyAccountLink) {
        headerMyAccountLink.addEventListener('click', (e) => {
            e.preventDefault();
            openPanel();
        });
    }

    accountCloseBtn.addEventListener('click', closePanel);
    accountOverlay.addEventListener('click', closePanel);

    signinForm.addEventListener('click', function() {
        if (!signinForm.classList.contains('active')) {
            signinForm.classList.add('active');
            signinForm.classList.remove('inactive');
            signupForm.classList.add('inactive');
            signupForm.classList.remove('active');
            accountArrow.classList.add('visible');
        }
    });

    signupForm.addEventListener('click', function() {
        if (!signupForm.classList.contains('active')) {
            signupForm.classList.add('active');
            signupForm.classList.remove('inactive');
            signinForm.classList.add('inactive');
            signinForm.classList.remove('active');
            accountArrow.classList.add('visible');
        }
    });

    accountArrow.addEventListener('click', function(e) {
        e.stopPropagation();
        resetForms();
    });

    signinFormData.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('signinEmail').value;
        const password = document.getElementById('signinPassword').value;
        const users = JSON.parse(localStorage.getItem('brandeduk-users') || '[]');
        const user = users.find(u => u.email === email && u.password === password);
        if (user) {
            localStorage.setItem(USER_SESSION_KEY, JSON.stringify(user));
            showLoggedInView(user);
            alert('Welcome back, ' + user.firstName + '!');
        } else {
            alert('Invalid email or password');
        }
    });

    signupFormData.addEventListener('submit', function(e) {
        e.preventDefault();
        const firstName = document.getElementById('signupFirstName').value;
        const lastName = document.getElementById('signupLastName').value;
        const email = document.getElementById('signupEmail').value;
        const phone = document.getElementById('signupPhone').value;
        const company = document.getElementById('signupCompany').value;
        const password = document.getElementById('signupPassword').value;
        const users = JSON.parse(localStorage.getItem('brandeduk-users') || '[]');
        if (users.find(u => u.email === email)) {
            alert('Email already registered');
            return;
        }
        const newUser = { firstName, lastName, email, phone, company, password };
        users.push(newUser);
        localStorage.setItem('brandeduk-users', JSON.stringify(users));
        localStorage.setItem(USER_SESSION_KEY, JSON.stringify(newUser));
        showLoggedInView(newUser);
        alert('Welcome, ' + firstName + '!');
    });

    accountLogoutBtn.addEventListener('click', function() {
        localStorage.removeItem(USER_SESSION_KEY);
        showFormsView();
        closePanel();
        alert('Signed out successfully');
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && accountPanel.classList.contains('active')) {
            closePanel();
        }
    });
});
</script>
</body>
</html>
